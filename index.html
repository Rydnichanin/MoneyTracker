<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>–£—á—ë—Ç –ö—É—Ä—å–µ—Ä–∞ Pro</title>
  <style>
    :root { --bg: #000; --card: #1c1c1e; --text: #fff; --pos: #65d48b; --neg: #ff6b6b; --accent: #ffd166; }
    * { box-sizing: border-box; font-family: -apple-system, sans-serif; }
    body { background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
    .wrap { max-width: 500px; margin: 0 auto; }
    .card { background: var(--card); border-radius: 16px; padding: 15px; margin-bottom: 12px; border: 1px solid #222; }
    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #333; background: #2c2c2e; color: #fff; font-size: 16px; outline: none; }
    .btn-main { width: 100%; padding: 14px; border: none; border-radius: 10px; background: var(--pos); color: #000; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }
    .scroll-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; scrollbar-width: none; }
    .scroll-container::-webkit-scrollbar { display: none; }
    .chip { flex: 0 0 auto; background: #333; color: var(--accent); padding: 8px 14px; border-radius: 8px; font-weight: bold; border: none; font-size: 14px; cursor: pointer; }
    .chip-period { color: #fff; background: #2c2c2e; border: 1px solid #444; font-size: 13px; }
    .gas-box { margin-top: 10px; font-size: 11px; }
    .gas-bar { height: 4px; background: #333; border-radius: 2px; margin: 4px 0; overflow: hidden; }
    .gas-fill { height: 100%; background: var(--accent); width: 0%; transition: 0.3s; }
    .collapsible-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 5px 0; }
    .arrow { font-size: 12px; color: #666; }
    .hidden { display: none; }
    .balance-line { display: flex; justify-content: space-between; text-align: center; margin-bottom: 10px; }
    .pos { color: var(--pos); } .neg { color: var(--neg); } .muted { color: #888; }
    .stat-row { border-bottom: 1px solid #222; padding: 12px 0; }
    .stat-main { display: flex; justify-content: space-between; width: 100%; font-size: 16px; font-weight: bold; }
    .stat-sub { font-size: 11px; color: #777; margin-top: 4px; }
    .item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #333; align-items: flex-start; }
    .set-item { background: #2c2c2e; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 14px; }
    .set-item button { background: none; border: none; color: var(--neg); float: right; font-size: 16px; cursor: pointer; }
    .gain-box { background: #1a2e21; padding: 15px; border-radius: 12px; border: 1px solid var(--pos); margin-top: 15px; display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; }

    /* –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ */
    .analytics-title { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin: 15px 0 8px; }
    .best-worst { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 5px; }
    .bw-card { border-radius: 10px; padding: 10px; text-align: center; }
    .bw-card.best { background: #1a2e21; border: 1px solid var(--pos); }
    .bw-card.worst { background: #2e1a1a; border: 1px solid var(--neg); }
    .bw-date { font-size: 10px; color: #888; margin-bottom: 3px; }
    .bw-sum { font-size: 18px; font-weight: bold; }
    .month-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #222; font-size: 14px; }
    .month-bar-wrap { height: 3px; background: #333; border-radius: 2px; margin-top: 4px; }
    .month-bar { height: 100%; background: #a78bfa; border-radius: 2px; transition: 0.3s; }

    /* –ì—Ä–∞—Ñ–∏–∫ */
    .chart-wrap { overflow-x: auto; padding-bottom: 5px; margin-bottom: 5px; }
    .chart-svg { display: block; }
  </style>

  <!-- Firebase ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBYvSsrzjgkrBwhaBAt0KlCGrAtzgOPYx8",
      authDomain: "moneytracker-5335b.firebaseapp.com",
      projectId: "moneytracker-5335b",
      storageBucket: "moneytracker-5335b.firebasestorage.app",
      messagingSenderId: "440589448883",
      appId: "1:440589448883:web:5ad507b270fa414731a2c6"
    };

    const app = initializeApp(firebaseConfig);
    window.fbDB = getFirestore(app);
    window.fbMethods = { collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, arrayUnion };

    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    window.fbSignIn = () => signInWithPopup(auth, provider);
    window.fbSignOut = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
      const loginScreen = document.getElementById("loginScreen");
      const appScreen = document.getElementById("appScreen");
      const userInfo = document.getElementById("userInfo");

      if (user) {
        loginScreen.style.display = "none";
        appScreen.style.display = "block";
        userInfo.textContent = user.displayName || user.email;
        window.fbUser = user;
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        if (!window.appStarted) {
          window.appStarted = true;
          window.dispatchEvent(new Event("fbReady"));
        }
      } else {
        loginScreen.style.display = "flex";
        appScreen.style.display = "none";
        window.fbUser = null;
        window.appStarted = false;
      }
    });
  </script>
</head>
<body>

  <!-- –≠–ö–†–ê–ù –í–•–û–î–ê -->
  <div id="loginScreen" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:#000; text-align:center; padding:20px;">
    <div style="font-size:48px; margin-bottom:16px;">üí∞</div>
    <h2 style="color:#fff; margin-bottom:8px;">–£—á—ë—Ç –ö—É—Ä—å–µ—Ä–∞ Pro</h2>
    <p style="color:#888; margin-bottom:32px; font-size:14px;">–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</p>
    <button onclick="fbSignIn()" style="display:flex; align-items:center; gap:12px; background:#fff; color:#000; border:none; border-radius:12px; padding:14px 24px; font-size:16px; font-weight:bold; cursor:pointer;">
      <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#4285F4" d="M44.5 20H24v8.5h11.8C34.7 33.9 29.8 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 5.1 29.6 3 24 3 12.4 3 3 12.4 3 24s9.4 21 21 21c10.5 0 20-7.6 20-21 0-1.4-.1-2.7-.5-4z"/></svg>
      –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
    </button>
  </div>

  <!-- –ü–†–ò–õ–û–ñ–ï–ù–ò–ï -->
  <div id="appScreen" style="display:none;">
    <!-- –®–∞–ø–∫–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º -->
    <div style="max-width:500px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; padding:8px 4px; margin-bottom:4px;">
      <span id="userInfo" style="font-size:12px; color:#666;"></span>
      <button onclick="fbSignOut()" style="background:none; border:1px solid #333; color:#666; border-radius:8px; padding:4px 10px; font-size:12px; cursor:pointer;">–í—ã–π—Ç–∏</button>
    </div>

  <div class="wrap">

    <!-- –§–û–†–ú–ê –ó–ê–ü–ò–°–ò -->
    <section class="card">
      <form id="txForm">
        <div class="row2">
          <select id="type"><option value="income">–ü—Ä–∏—Ö–æ–¥</option><option value="expense">–†–∞—Å—Ö–æ–¥</option></select>
          <select id="accountSelect"></select>
        </div>
        <div class="row2">
          <select id="category"></select>
          <div id="subcatWrap" class="hidden"><select id="subcategory"></select></div>
        </div>
        <div class="row2">
          <input id="amount" type="number" inputmode="decimal" placeholder="–°—É–º–º–∞" required />
          <input id="date" type="date" required />
        </div>
        <input id="comment" type="text" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ" style="margin-bottom:10px;" />
        <div class="scroll-container">
          <button type="button" class="chip" onclick="setAmount(150)">150</button>
          <button type="button" class="chip" onclick="setAmount(300)">300</button>
          <button type="button" class="chip" onclick="setAmount(500)">500</button>
          <button type="button" class="chip" onclick="setAmount(600)">600</button>
          <button type="button" class="chip" onclick="setAmount(1000)">1000</button>
          <button type="button" class="chip" onclick="setAmount(2000)">2k</button>
          <button type="button" class="chip" onclick="setAmount(2500)">2.5k</button>
          <button type="button" class="chip" onclick="setAmount(4500)">4.5k</button>
          <button type="button" class="chip" onclick="setAmount(5000)">5k</button>
        </div>
        <button class="btn-main" type="submit">–ó–∞–ø–∏—Å–∞—Ç—å</button>
      </form>
    </section>

    <!-- –ë–ê–õ–ê–ù–° –ò –ü–ï–†–ò–û–î -->
    <section class="card">
      <div class="collapsible-header" onclick="toggleBlock(this)"><h3>üí∞ –ë–∞–ª–∞–Ω—Å –∏ –ü–µ—Ä–∏–æ–¥</h3><span class="arrow">‚ñ≤</span></div>
      <div class="content">
        <div class="balance-line">
          <div><small class="muted">–ß–∏—Å—Ç–∞—è</small><br><b id="balance" style="font-size: 20px;">0 ‚Ç∏</b></div>
          <div><small class="muted">–ü—Ä–∏—Ö–æ–¥</small><br><b id="totalIncome" class="pos">0 ‚Ç∏</b></div>
          <div><small class="muted">–†–∞—Å—Ö–æ–¥</small><br><b id="totalExpense" class="neg">0 ‚Ç∏</b></div>
        </div>
        <div id="accountBalances" style="font-size:11px; margin-bottom:12px; color:#aaa; display:flex; gap:10px; flex-wrap:wrap;"></div>
        <div class="gas-box">
          <div id="gasText" style="color:#888;">–ë–µ–Ω–∑–∏–Ω: 0%</div>
          <div class="gas-bar"><div id="gasFill" class="gas-fill"></div></div>
        </div>
        <div class="row2" style="margin-top:15px;">
          <input type="date" id="fromDate">
          <input type="date" id="toDate">
        </div>
        <div class="scroll-container">
          <button type="button" class="chip chip-period" onclick="setRange('today')">–°–µ–≥–æ–¥–Ω—è</button>
          <button type="button" class="chip chip-period" onclick="setRange('yesterday')">–í—á–µ—Ä–∞</button>
          <button type="button" class="chip chip-period" onclick="setRange('all')">–í—Å–µ –≤—Ä–µ–º—è</button>
        </div>
      </div>
    </section>

    <!-- –î–û–•–û–î –ü–û –¢–û–ß–ö–ê–ú -->
    <section class="card">
      <div class="collapsible-header" onclick="toggleBlock(this)"><h3>üìà –î–æ—Ö–æ–¥ –ø–æ —Ç–æ—á–∫–∞–º</h3><span class="arrow">‚ñ≤</span></div>
      <div id="earningsDetails" class="content"></div>
    </section>

    <!-- –í–û–ó–ú–û–ñ–ù–´–ô –î–û–•–û–î -->
    <section class="card" style="border: 1px solid #444;">
      <div class="collapsible-header" onclick="toggleBlock(this)"><h3 style="color:var(--accent)">üîÆ –í–æ–∑–º–æ–∂–Ω—ã–π –¥–æ—Ö–æ–¥</h3><span class="arrow">‚ñ≤</span></div>
      <div id="potentialStats" class="content"></div>
    </section>

    <!-- –†–ê–°–•–û–î–´ –ü–û –ö–ê–¢–ï–ì–û–†–ò–Ø–ú -->
    <section class="card">
      <div class="collapsible-header" onclick="toggleBlock(this)"><h3>üìâ –†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3><span class="arrow">‚ñº</span></div>
      <div id="expenseDetails" class="content hidden"></div>
    </section>

    <!-- –ê–ù–ê–õ–ò–¢–ò–ö–ê -->
    <section class="card" style="border: 1px solid #2a2a4a;">
      <div class="collapsible-header" onclick="toggleBlock(this)"><h3 style="color:#a78bfa;">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h3><span class="arrow">‚ñº</span></div>
      <div class="content hidden">
        <div id="analyticsContent"></div>
      </div>
    </section>

    <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
    <section class="card" style="border: 1px solid #333;">
      <div class="collapsible-header" onclick="toggleBlock(this)"><h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3><span class="arrow">‚ñº</span></div>
      <div class="content hidden">
        <div style="margin-bottom:15px;">
          <small class="muted">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</small>
          <div class="row2" style="margin-top:5px;">
            <select id="setCatType"><option value="income">–ü—Ä–∏—Ö–æ–¥</option><option value="expense">–†–∞—Å—Ö–æ–¥</option></select>
            <input id="setCatName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
          </div>
          <button class="btn-main" style="background:#444; color:#fff; padding:8px;" onclick="addCategory()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div style="margin-bottom:15px; border-top:1px solid #222; padding-top:10px;">
          <small class="muted">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è:</small>
          <div class="row2" style="margin-top:5px;">
            <select id="setParentCat"></select>
            <input id="setSubName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
          </div>
          <button class="btn-main" style="background:#444; color:#fff; padding:8px;" onclick="addSub()">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∫–∞—Ç.</button>
        </div>
        <div style="margin-bottom:15px; border-top:1px solid #222; padding-top:10px;">
          <small class="muted">–°—á–µ—Ç:</small>
          <div class="row2" style="margin-top:5px;">
            <input id="setAccName" type="text" placeholder="–ù–∞–ø—Ä: –ö–∞—Å–ø–∏">
            <button class="btn-main" style="background:#444; color:#fff; padding:8px; margin:0;" onclick="addAccount()">–û–ö</button>
          </div>
        </div>
        <div id="settingsList" style="margin-top:15px;"></div>
      </div>
    </section>

    <!-- –ò–°–¢–û–†–ò–Ø -->
    <section class="card">
      <div class="collapsible-header" onclick="toggleBlock(this)"><h3>üìù –ò—Å—Ç–æ—Ä–∏—è</h3><span class="arrow">‚ñº</span></div>
      <div id="list" class="content hidden"></div>
    </section>

  </div>
  </div> <!-- /appScreen -->

  <script>
    window.toggleBlock = function(el) {
      const content = el.nextElementSibling;
      content.classList.toggle('hidden');
      el.querySelector('.arrow').textContent = content.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
    };
    window.setAmount = function(v) { document.getElementById('amount').value = v; };
  </script>

  <script>
    let DEFAULTS = { income: [], expense: [] };
    let ACCOUNTS = [];
    let allTx = [];

    // –ñ–¥—ë–º —Å–∏–≥–Ω–∞–ª–∞ –æ—Ç Firebase Auth —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à—ë–ª
    window.addEventListener("fbReady", initApp);

    function initApp() {
      const { fbDB, fbMethods } = window;
      const txRef = fbMethods.collection(fbDB, "transactions");
      const setRef = fbMethods.collection(fbDB, "settings");

      const setToday = () => {
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000;
        // –ï—Å–ª–∏ –≤—Ä–µ–º—è –¥–æ 03:00 ‚Äî —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –µ—â—ë "–≤—á–µ—Ä–∞"
        if (now.getHours() < 3) {
          now.setDate(now.getDate() - 1);
        }
        const local = new Date(now - offset).toISOString().split('T')[0];
        document.getElementById("date").value = local;
        return local;
      };
      setToday();

      document.getElementById("fromDate").oninput = render;
      document.getElementById("toDate").oninput = render;

      // –ù–ê–°–¢–†–û–ô–ö–ò ‚Äî —Å–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
      fbMethods.onSnapshot(setRef, (snap) => {
        DEFAULTS = { income: [], expense: [] };
        ACCOUNTS = [];
        let setHtml = "";

        snap.forEach(d => {
          const data = d.data();
          if (data.type === 'category') {
            DEFAULTS[data.catType].push({ id: d.id, ...data });
            const subButtons = (data.sub || []).map(s =>
              `<span style="display:inline-flex;align-items:center;gap:3px;background:#333;border-radius:5px;padding:2px 6px;margin:2px;">
                ${s}
                <button onclick="deleteSub('${d.id}','${s}')" style="background:none;border:none;color:var(--neg);font-size:12px;padding:0;cursor:pointer;line-height:1;">‚úï</button>
              </span>`
            ).join("");
            setHtml += `<div class="set-item">üìÇ ${data.name} (${data.catType === 'income' ? '+' : '-'})
              <button onclick="deleteSet('${d.id}')">‚úï</button>
              <div style="margin-top:5px;flex-wrap:wrap;display:flex;gap:2px;">${subButtons || '<span style="color:#555;font-size:10px;">–Ω–µ—Ç –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π</span>'}</div>
            </div>`;
          } else if (data.type === 'account') {
            ACCOUNTS.push({ id: d.id, ...data });
            setHtml += `<div class="set-item">üí≥ ${data.name} <button onclick="deleteSet('${d.id}')">‚úï</button></div>`;
          }
        });

        document.getElementById("settingsList").innerHTML = setHtml || '<div class="muted">–ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫</div>';
        updateUI();
      });

      window.addCategory = async () => {
        const name = document.getElementById("setCatName").value.trim();
        const catType = document.getElementById("setCatType").value;
        if (name) await fbMethods.addDoc(setRef, { type: 'category', name, catType, sub: [] });
        document.getElementById("setCatName").value = "";
      };

      window.addAccount = async () => {
        const name = document.getElementById("setAccName").value.trim();
        if (name) await fbMethods.addDoc(setRef, { type: 'account', name });
        document.getElementById("setAccName").value = "";
      };

      window.addSub = async () => {
        const parentId = document.getElementById("setParentCat").value;
        const subName = document.getElementById("setSubName").value.trim();
        if (parentId && subName) {
          await fbMethods.updateDoc(fbMethods.doc(fbDB, "settings", parentId), {
            sub: fbMethods.arrayUnion(subName)
          });
        }
        document.getElementById("setSubName").value = "";
      };

      window.deleteSet = async (id) => {
        if (confirm("–£–¥–∞–ª–∏—Ç—å?")) await fbMethods.deleteDoc(fbMethods.doc(fbDB, "settings", id));
      };

      window.deleteSub = async (catId, subName) => {
        if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é "${subName}"?`)) {
          const cat = [...DEFAULTS.income, ...DEFAULTS.expense].find(c => c.id === catId);
          if (!cat) return;
          const newSubs = (cat.sub || []).filter(s => s !== subName);
          await fbMethods.updateDoc(fbMethods.doc(fbDB, "settings", catId), { sub: newSubs });
        }
      };

      function updateUI() {
        const elT = document.getElementById("type");
        const elC = document.getElementById("category");
        const elS = document.getElementById("subcategory");
        const elAcc = document.getElementById("accountSelect");

        elAcc.innerHTML = ACCOUNTS.length
          ? ACCOUNTS.map(a => `<option value="${a.name}">${a.name}</option>`).join("")
          : '<option value="">–°—á–µ—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω</option>';

        const currentCats = DEFAULTS[elT.value] || [];
        elC.innerHTML = currentCats.map(c => `<option value="${c.id}">${c.name}</option>`).join("");

        document.getElementById("setParentCat").innerHTML = [...DEFAULTS.income, ...DEFAULTS.expense]
          .map(c => `<option value="${c.id}">${c.name}</option>`).join("");

        const fillSubs = () => {
          const cat = currentCats.find(c => c.id === elC.value);
          if (cat && cat.sub && cat.sub.length > 0) {
            document.getElementById("subcatWrap").classList.remove("hidden");
            elS.innerHTML = cat.sub.map(s => `<option value="${s}">${s}</option>`).join("");
          } else {
            document.getElementById("subcatWrap").classList.add("hidden");
            elS.innerHTML = "";
          }
        };

        elT.onchange = updateUI;
        elC.onchange = fillSubs;
        fillSubs();
      }

      // –¢–†–ê–ù–ó–ê–ö–¶–ò–ò ‚Äî —Å–ª—É—à–∞–µ–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
      fbMethods.onSnapshot(fbMethods.query(txRef, fbMethods.orderBy("date", "desc")), (snap) => {
        allTx = [];
        snap.forEach(d => allTx.push({ id: d.id, ...d.data() }));
        if (!document.getElementById("fromDate").value) setRange('today');
        else render();
      });

      // –§–û–†–ú–ê
      document.getElementById("txForm").onsubmit = async (e) => {
        e.preventDefault();
        const amt = Number(document.getElementById("amount").value);
        if (!amt) return;
        const catId = document.getElementById("category").value;
        const catObj = [...DEFAULTS.income, ...DEFAULTS.expense].find(c => c.id === catId);
        await fbMethods.addDoc(txRef, {
          type: document.getElementById("type").value,
          amount: amt,
          categoryName: catObj ? catObj.name : "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",
          subcategory: document.getElementById("subcategory").value || "",
          account: document.getElementById("accountSelect").value,
          date: document.getElementById("date").value,
          time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
          createdAt: Date.now(),
          comment: document.getElementById("comment").value
        });
        document.getElementById("amount").value = "";
        document.getElementById("comment").value = "";
        setToday();
      };
    }

    // –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ü–ï–†–ò–û–î–ê
    window.setRange = (mode) => {
      const f = document.getElementById("fromDate");
      const t = document.getElementById("toDate");
      const now = new Date();
      const offset = now.getTimezoneOffset() * 60000;
      const today = new Date(now - offset).toISOString().split('T')[0];

      if (mode === 'today') {
        f.value = today; t.value = today;
      } else if (mode === 'yesterday') {
        const y = new Date(now - offset);
        y.setDate(y.getDate() - 1);
        const yStr = y.toISOString().split('T')[0];
        f.value = yStr; t.value = yStr;
      } else {
        f.value = ""; t.value = "";
      }
      render();
    };

    // –†–ï–ù–î–ï–†
    function render() {
      const from = document.getElementById("fromDate").value;
      const to = document.getElementById("toDate").value;
      const filtered = allTx
        .filter(t => (!from || t.date >= from) && (!to || t.date <= to))
        .sort((a, b) => {
          if (b.date !== a.date) return b.date > a.date ? 1 : -1;
          return (b.createdAt || 0) - (a.createdAt || 0);
        });

      const inc = filtered.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
      const exp = filtered.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
      const gas = filtered.filter(t => t.type === 'expense' && (
        String(t.subcategory || '').toLowerCase().includes('–±–µ–Ω–∑') ||
        String(t.categoryName || '').toLowerCase().includes('–±–µ–Ω–∑')
      )).reduce((s, t) => s + t.amount, 0);

      document.getElementById("balance").textContent = (inc - exp).toLocaleString() + " ‚Ç∏";
      document.getElementById("totalIncome").textContent = inc.toLocaleString() + " ‚Ç∏";
      document.getElementById("totalExpense").textContent = exp.toLocaleString() + " ‚Ç∏";

      // –ë–∞–ª–∞–Ω—Å –ø–æ —Å—á–µ—Ç–∞–º
      const accs = {};
      filtered.forEach(t => {
        const acc = t.account && t.account !== 'undefined' ? t.account : null;
        if (!acc) return;
        if (!accs[acc]) accs[acc] = 0;
        accs[acc] += (t.type === 'income' ? t.amount : -t.amount);
      });
      document.getElementById("accountBalances").innerHTML = Object.entries(accs)
        .map(([n, v]) => `<span>${n}: <b style="color:${v >= 0 ? '#65d48b' : '#ff6b6b'}">${v.toLocaleString()}</b></span>`)
        .join(" | ");

      const gasP = inc > 0 ? ((gas / inc) * 100).toFixed(1) : 0;
      document.getElementById("gasText").textContent = `–ë–µ–Ω–∑–∏–Ω: ${gasP}% (${gas.toLocaleString()} ‚Ç∏)`;
      document.getElementById("gasFill").style.width = Math.min(Number(gasP) * 3, 100) + "%";

      // –î–æ—Ö–æ–¥ –ø–æ —Ç–æ—á–∫–∞–º
      const statsInc = {};
      filtered.filter(t => t.type === 'income').forEach(t => {
        const key = t.subcategory || t.categoryName;
        if (!statsInc[key]) statsInc[key] = { sum: 0, cnt: 0, br: {} };
        statsInc[key].sum += t.amount;
        statsInc[key].cnt++;
        statsInc[key].br[t.amount] = (statsInc[key].br[t.amount] || 0) + 1;
      });
      document.getElementById("earningsDetails").innerHTML = Object.entries(statsInc).map(([k, d]) => `
        <div class="stat-row">
          <div class="stat-main"><span>${k} (${d.cnt})</span><b>${d.sum.toLocaleString()} ‚Ç∏</b></div>
          <div class="stat-sub">${Object.entries(d.br).map(([p, c]) => `${p}‚Ç∏√ó${c}`).join(" | ")}</div>
        </div>`).join("") || '<div class="muted" style="padding:10px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';

      // –í–æ–∑–º–æ–∂–Ω—ã–π –¥–æ—Ö–æ–¥
      let totalGain = 0;
      const vdStats = {};
      const vds = ["F1", "F2", "F3", "–ù–æ—á—å"];

      // –°—á–∏—Ç–∞–µ–º –í–î —Ç–æ–ª—å–∫–æ –ø–æ –∑–∞–ø–∏—Å—è–º < 3000
      filtered.forEach(t => {
        if (t.type === 'income' && vds.includes(t.subcategory) && t.amount < 3000) {
          if (!vdStats[t.subcategory]) vdStats[t.subcategory] = { vdSum: 0 };
          let p = t.amount;
          if (t.amount === 150) p = 600;
          else if (t.amount === 300) p = 900;
          else if (t.subcategory === "–ù–æ—á—å" && t.amount === 500) p = 1000;
          vdStats[t.subcategory].vdSum += p;
        }
      });

      const vdHtml = Object.entries(vdStats).map(([p, data]) => {
        // –í—ã—á–∏—Ç–∞–µ–º –í–°–ï —Ä–µ–∞–ª—å–Ω—ã–µ –¥–æ—Ö–æ–¥—ã —Å —ç—Ç–æ–π —Ç–æ—á–∫–∏ (–≤–∫–ª—é—á–∞—è ‚â•3000)
        const rSum = statsInc[p] ? statsInc[p].sum : 0;
        const diff = data.vdSum - rSum;
        totalGain += diff;
        return `<div class="stat-row">
          <div class="stat-main"><span>${p}</span><b>${data.vdSum.toLocaleString()} ‚Ç∏</b></div>
          <div style="color:#65d48b;font-size:12px;">–í—ã–≥–æ–¥–∞: +${diff.toLocaleString()} ‚Ç∏</div>
        </div>`;
      }).join("");
      document.getElementById("potentialStats").innerHTML = vdHtml || '<div class="muted" style="padding:10px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –í–î</div>';
      if (totalGain > 0) {
        document.getElementById("potentialStats").innerHTML +=
          `<div class="gain-box"><span>–í–´–ì–û–î–ê –í–î:</span><span class="pos">+${totalGain.toLocaleString()} ‚Ç∏</span></div>`;
      }

      // –†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
      const statsExp = {};
      filtered.filter(t => t.type === 'expense').forEach(t => {
        if (!statsExp[t.categoryName]) statsExp[t.categoryName] = { sum: 0, subs: {} };
        statsExp[t.categoryName].sum += t.amount;
        if (t.subcategory) statsExp[t.categoryName].subs[t.subcategory] = (statsExp[t.categoryName].subs[t.subcategory] || 0) + t.amount;
      });
      document.getElementById("expenseDetails").innerHTML = Object.entries(statsExp).map(([c, d]) => `
        <div class="stat-row">
          <div class="stat-main"><span>${c}</span><b class="neg">${d.sum.toLocaleString()} ‚Ç∏</b></div>
          <div class="stat-sub">${Object.entries(d.subs).map(([s, v]) => `${s}: ${v.toLocaleString()}`).join(" | ")}</div>
        </div>`).join("") || '<div class="muted" style="padding:10px;">–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤</div>';

      // –ò—Å—Ç–æ—Ä–∏—è
      document.getElementById("list").innerHTML = filtered.map(t => {
        const acc = t.account && t.account !== 'undefined' && t.account !== '' ? ` [${t.account}]` : '';
        const timeStr = t.time ? `${t.date} ${t.time}` : t.date;
        return `<div class="item">
          <div>
            <b class="${t.type === 'income' ? 'pos' : 'neg'}">${t.amount.toLocaleString()} ‚Ç∏</b><br>
            <small class="muted">${timeStr} | ${t.subcategory || t.categoryName}${acc}</small>
            ${t.comment ? `<div style="color:#65d48b;font-size:12px;">üìù ${t.comment}</div>` : ''}
          </div>
          <button onclick="deleteTx('${t.id}')" style="background:none;border:none;color:#444;padding:10px;cursor:pointer;">‚úï</button>
        </div>`;
      }).join("") || '<div class="muted" style="padding:10px;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';

      renderAnalytics();
    }

    window.render = render;

    function renderAnalytics() {
      const el = document.getElementById("analyticsContent");
      if (!el) return;

      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ –¥–∞—Ç–µ
      const byDay = {};
      const byMonth = {};

      allTx.forEach(t => {
        if (t.type !== 'income') return;
        const d = t.date || '';
        const m = d.slice(0, 7); // YYYY-MM
        if (!byDay[d]) byDay[d] = 0;
        byDay[d] += t.amount;
        if (!byMonth[m]) byMonth[m] = { inc: 0, exp: 0 };
        byMonth[m].inc += t.amount;
      });
      allTx.forEach(t => {
        if (t.type !== 'expense') return;
        const m = (t.date || '').slice(0, 7);
        if (!byMonth[m]) byMonth[m] = { inc: 0, exp: 0 };
        byMonth[m].exp += t.amount;
      });

      // –õ—É—á—à–∏–π –∏ —Ö—É–¥—à–∏–π –¥–µ–Ω—å
      const days = Object.entries(byDay).filter(([d]) => d);

      // –î–Ω–∏ –≥–¥–µ –±—ã–ª–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ F1/F2/F3/–ù–æ—á—å
      const deliveryDays = new Set();
      allTx.forEach(t => {
        if (t.type === 'income' && ["F1","F2","F3","–ù–æ—á—å"].includes(t.subcategory)) {
          deliveryDays.add(t.date);
        }
      });

      let bestDay = null, worstDay = null;
      if (days.length > 0) {
        bestDay = days.reduce((a, b) => b[1] > a[1] ? b : a);
        const deliveryDaysList = days.filter(([d]) => deliveryDays.has(d));
        if (deliveryDaysList.length > 0) {
          worstDay = deliveryDaysList.reduce((a, b) => b[1] < a[1] ? b : a);
        }
      }

      const formatDate = (d) => {
        if (!d) return '‚Äî';
        const [y, mo, day] = d.split('-');
        return `${day}.${mo}.${y}`;
      };

      const formatMonth = (m) => {
        if (!m) return '‚Äî';
        const months = ['–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'];
        const [y, mo] = m.split('-');
        return `${months[parseInt(mo) - 1]} ${y}`;
      };

      // –ì—Ä–∞—Ñ–∏–∫ –ø–æ –¥–Ω—è–º (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞)
      const from = document.getElementById("fromDate").value;
      const to = document.getElementById("toDate").value;
      const filteredDays = Object.entries(byDay)
        .filter(([d]) => d && (!from || d >= from) && (!to || d <= to))
        .sort((a, b) => a[0] > b[0] ? 1 : -1)
        .slice(-14);

      let chartHtml = '';
      let chartData = null;
      if (filteredDays.length > 1) {
        const maxVal = Math.max(...filteredDays.map(([, v]) => v));
        const W = Math.max(filteredDays.length * 36, 300);
        const H = 80;
        const pad = 5;
        chartData = { filteredDays, maxVal, W, H, pad };

        chartHtml = `
          <div class="analytics-title">–ì—Ä–∞—Ñ–∏–∫ –¥–æ—Ö–æ–¥–∞ –ø–æ –¥–Ω—è–º</div>
          <div style="position:relative; margin-bottom:8px;">
            <div id="chartTooltip" style="text-align:center;height:28px;display:flex;align-items:center;justify-content:center;gap:8px;">
              <span id="chartTipDate" style="font-size:11px;color:#888;"></span>
              <span id="chartTipVal" style="font-size:16px;font-weight:bold;color:#a78bfa;"></span>
            </div>
            <div class="chart-wrap">
              <canvas id="incomeChart" width="${W}" height="${H + 20}" style="display:block;cursor:crosshair;"></canvas>
            </div>
          </div>`;
      }

      // –õ—É—á—à–∏–π/—Ö—É–¥—à–∏–π
      const bwHtml = bestDay ? `
        <div class="analytics-title">–õ—É—á—à–∏–π –∏ —Ö—É–¥—à–∏–π –¥–µ–Ω—å</div>
        <div class="best-worst">
          <div class="bw-card best">
            <div class="bw-date">üèÜ –õ—É—á—à–∏–π</div>
            <div class="bw-sum pos">${bestDay[1].toLocaleString()} ‚Ç∏</div>
            <div class="bw-date">${formatDate(bestDay[0])}</div>
          </div>
          <div class="bw-card worst">
            <div class="bw-date">üìâ –•—É–¥—à–∏–π</div>
            <div class="bw-sum neg">${worstDay[1].toLocaleString()} ‚Ç∏</div>
            <div class="bw-date">${formatDate(worstDay[0])}</div>
          </div>
        </div>` : '';

      // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –º–µ—Å—è—Ü–∞–º
      const sortedMonths = Object.entries(byMonth).sort((a, b) => b[0] > a[0] ? 1 : -1).slice(0, 6);
      const maxInc = Math.max(...sortedMonths.map(([, d]) => d.inc), 1);
      const monthHtml = sortedMonths.length > 0 ? `
        <div class="analytics-title">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –º–µ—Å—è—Ü–∞–º</div>
        ${sortedMonths.map(([m, d]) => `
          <div class="month-row">
            <div style="flex:1;">
              <div style="display:flex;justify-content:space-between;">
                <span>${formatMonth(m)}</span>
                <span class="pos">${d.inc.toLocaleString()} ‚Ç∏</span>
              </div>
              <div class="month-bar-wrap">
                <div class="month-bar" style="width:${(d.inc / maxInc * 100).toFixed(1)}%"></div>
              </div>
            </div>
            <div style="margin-left:12px;text-align:right;font-size:12px;">
              <div class="neg">‚àí${d.exp.toLocaleString()}</div>
              <div style="color:#aaa;font-size:11px;">—á–∏—Å—Ç: ${(d.inc - d.exp).toLocaleString()}</div>
            </div>
          </div>`).join('')}` : '';

      el.innerHTML = chartHtml + bwHtml + monthHtml || '<div class="muted" style="padding:10px;">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö</div>';

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º canvas –ü–û–°–õ–ï –≤—Å—Ç–∞–≤–∫–∏ –≤ DOM
      if (chartData) {
        const { filteredDays, maxVal, W, H, pad } = chartData;
        const canvas = document.getElementById('incomeChart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');

        function getX(i) { return pad + i * ((W - pad*2) / (filteredDays.length - 1)); }
        function getY(v) { return H - pad - ((v / maxVal) * (H - pad*2)); }

        function draw(activeIdx) {
          ctx.clearRect(0, 0, W, H + 20);

          // –ì—Ä–∞–¥–∏–µ–Ω—Ç –ø–æ–¥ –ª–∏–Ω–∏–µ–π
          const grad = ctx.createLinearGradient(0, 0, 0, H);
          grad.addColorStop(0, 'rgba(167,139,250,0.3)');
          grad.addColorStop(1, 'rgba(167,139,250,0)');
          ctx.beginPath();
          ctx.moveTo(getX(0), getY(filteredDays[0][1]));
          filteredDays.forEach(([,v], i) => ctx.lineTo(getX(i), getY(v)));
          ctx.lineTo(getX(filteredDays.length-1), H);
          ctx.lineTo(getX(0), H);
          ctx.closePath();
          ctx.fillStyle = grad;
          ctx.fill();

          // –õ–∏–Ω–∏—è
          ctx.beginPath();
          ctx.strokeStyle = '#a78bfa';
          ctx.lineWidth = 2.5;
          ctx.lineJoin = 'round';
          ctx.moveTo(getX(0), getY(filteredDays[0][1]));
          filteredDays.forEach(([,v], i) => ctx.lineTo(getX(i), getY(v)));
          ctx.stroke();

          // –¢–æ—á–∫–∏
          filteredDays.forEach(([,v], i) => {
            const x = getX(i), y = getY(v);
            if (i === activeIdx) {
              ctx.beginPath();
              ctx.strokeStyle = 'rgba(167,139,250,0.4)';
              ctx.lineWidth = 1;
              ctx.setLineDash([4,3]);
              ctx.moveTo(x, 0); ctx.lineTo(x, H);
              ctx.stroke();
              ctx.setLineDash([]);
              ctx.beginPath();
              ctx.arc(x, y, 7, 0, Math.PI*2);
              ctx.fillStyle = 'rgba(167,139,250,0.25)';
              ctx.fill();
              ctx.beginPath();
              ctx.arc(x, y, 4, 0, Math.PI*2);
              ctx.fillStyle = '#fff';
              ctx.fill();
              ctx.beginPath();
              ctx.arc(x, y, 2.5, 0, Math.PI*2);
              ctx.fillStyle = '#a78bfa';
              ctx.fill();
            } else {
              ctx.beginPath();
              ctx.arc(x, y, 3, 0, Math.PI*2);
              ctx.fillStyle = '#a78bfa';
              ctx.fill();
            }
          });

          // –ü–æ–¥–ø–∏—Å–∏ –¥–Ω–µ–π
          ctx.fillStyle = '#555';
          ctx.font = '9px sans-serif';
          ctx.textAlign = 'center';
          filteredDays.forEach(([d,], i) => {
            ctx.fillText(d.slice(8), getX(i), H + 14);
          });
        }

        function getClosestIdx(clientX) {
          const rect = canvas.getBoundingClientRect();
          const scaleX = W / rect.width;
          const mx = (clientX - rect.left) * scaleX;
          let closest = 0, minDist = Infinity;
          filteredDays.forEach(([,], i) => {
            const dist = Math.abs(getX(i) - mx);
            if (dist < minDist) { minDist = dist; closest = i; }
          });
          return closest;
        }

        function showTip(idx) {
          const [d, v] = filteredDays[idx];
          document.getElementById('chartTipDate').textContent = d.slice(8) + '.' + d.slice(5,7);
          document.getElementById('chartTipVal').textContent = v.toLocaleString() + ' ‚Ç∏';
          draw(idx);
        }

        function hideTip() {
          document.getElementById('chartTipDate').textContent = '';
          document.getElementById('chartTipVal').textContent = '';
          draw(-1);
        }

        canvas.addEventListener('touchmove', e => { e.preventDefault(); showTip(getClosestIdx(e.touches[0].clientX)); }, { passive: false });
        canvas.addEventListener('touchstart', e => { showTip(getClosestIdx(e.touches[0].clientX)); }, { passive: true });
        canvas.addEventListener('touchend', () => hideTip());
        canvas.addEventListener('mousemove', e => showTip(getClosestIdx(e.clientX)));
        canvas.addEventListener('mouseleave', () => hideTip());

        draw(-1);
      }
    }

    window.renderAnalytics = renderAnalytics;

    window.deleteTx = async (id) => {
      if (confirm("–£–¥–∞–ª–∏—Ç—å?")) {
        await window.fbMethods.deleteDoc(window.fbMethods.doc(window.fbDB, "transactions", id));
      }
    };
  </script>
</body>
</html>
