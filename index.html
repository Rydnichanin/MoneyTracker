<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>–£—á—ë—Ç –ö—É—Ä—å–µ—Ä–∞ Pro</title>
  <style>
    :root { --bg: #000; --card: #1c1c1e; --text: #fff; --pos: #65d48b; --neg: #ff6b6b; --accent: #ffd166; --nav-h: 65px; }
    * { box-sizing: border-box; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); color: var(--text); margin: 0; padding: 0; overflow-x: hidden; }

    .top-bar { position: fixed; top: 0; left: 0; right: 0; z-index: 100; background: #000; padding: 10px 12px 6px; }
    .top-balance { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: #1c1c1e; border-radius: 16px; border: 1px solid #2a2a2a; }
    .top-balance-main { font-size: 22px; font-weight: bold; }
    .top-balance-side { text-align: right; font-size: 11px; color: #666; }
    .top-balance-side b { display: block; font-size: 14px; }
    .acc-row { font-size: 11px; color: #555; margin-top: 5px; display: flex; gap: 8px; flex-wrap: wrap; }

    .gas-wrap { padding: 4px 2px 0; }
    .gas-label { font-size: 10px; color: #444; margin-bottom: 2px; }
    .gas-bar-bg { height: 3px; background: #1a1a1a; border-radius: 2px; overflow: hidden; }
    .gas-bar-fill { height: 100%; background: var(--accent); width: 0%; transition: 0.4s; }

    .period-row { display: flex; gap: 6px; padding: 6px 12px 4px; position: fixed; top: 100px; left: 0; right: 0; z-index: 99; background: #000; }
    .period-btn { flex: 1; padding: 7px 0; border: 1px solid #222; border-radius: 8px; background: #111; color: #555; font-size: 12px; cursor: pointer; font-weight: 600; }
    .period-btn.active { background: #1c1c1e; color: #fff; border-color: #444; }

    .page-wrap { max-width: 500px; margin: 0 auto; padding-top: 138px; padding-bottom: calc(var(--nav-h) + 8px); padding-left: 10px; padding-right: 10px; }

    .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; z-index: 100; display: flex; background: #0a0a0a; border-top: 1px solid #1a1a1a; height: var(--nav-h); max-width: 500px; margin: 0 auto; }
    .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; cursor: pointer; color: #333; border: none; background: none; padding-bottom: 6px; transition: color 0.15s; }
    .nav-item.active { color: var(--pos); }
    .nav-icon { font-size: 22px; line-height: 1; }
    .nav-label { font-size: 10px; font-weight: 600; }

    .tab { display: none; }
    .tab.active { display: block; }

    .card { background: var(--card); border-radius: 16px; padding: 14px; margin-bottom: 10px; border: 1px solid #222; }
    .card-title { font-size: 11px; color: #555; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
    input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #2a2a2a; background: #2c2c2e; color: #fff; font-size: 16px; outline: none; }
    .btn-main { width: 100%; padding: 14px; border: none; border-radius: 12px; background: var(--pos); color: #000; font-weight: bold; font-size: 16px; margin-top: 8px; cursor: pointer; }
    .chips { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 4px; margin-bottom: 8px; scrollbar-width: none; }
    .chips::-webkit-scrollbar { display: none; }
    .chip { flex: 0 0 auto; background: #2c2c2e; color: var(--accent); padding: 8px 14px; border-radius: 8px; font-weight: bold; border: 1px solid #333; font-size: 14px; cursor: pointer; }

    .stat-row { border-bottom: 1px solid #1a1a1a; padding: 11px 0; }
    .stat-main { display: flex; justify-content: space-between; font-size: 15px; font-weight: bold; }
    .stat-sub { font-size: 11px; color: #555; margin-top: 3px; }
    .gain-box { background: #0a1f10; padding: 13px; border-radius: 12px; border: 1px solid var(--pos); margin-top: 12px; display: flex; justify-content: space-between; font-weight: bold; font-size: 17px; }

    .hist-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 10px 0; border-bottom: 1px solid #1a1a1a; }
    .hist-del { background: none; border: none; color: #2a2a2a; padding: 8px; cursor: pointer; font-size: 16px; }

    .bw-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 4px; }
    .bw-card { border-radius: 12px; padding: 12px; text-align: center; }
    .bw-card.best { background: #0a1f10; border: 1px solid var(--pos); }
    .bw-card.worst { background: #1f0a0a; border: 1px solid var(--neg); }
    .bw-label { font-size: 10px; color: #666; margin-bottom: 4px; }
    .bw-val { font-size: 20px; font-weight: bold; }
    .bw-date { font-size: 10px; color: #555; margin-top: 3px; }

    .month-row { padding: 10px 0; border-bottom: 1px solid #1a1a1a; }
    .month-top { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 4px; }
    .month-bar-bg { height: 3px; background: #1a1a1a; border-radius: 2px; }
    .month-bar-fill { height: 100%; background: #a78bfa; border-radius: 2px; transition: 0.4s; }
    .month-meta { font-size: 10px; color: #3a3a3a; margin-top: 3px; }

    .sec-title { font-size: 11px; color: #444; text-transform: uppercase; letter-spacing: 1px; margin: 14px 0 8px; }
    .chart-wrap { overflow-x: scroll; -webkit-overflow-scrolling: touch; }

    .set-item { background: #242424; padding: 10px 12px; border-radius: 10px; margin-bottom: 8px; }
    .set-item-top { display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
    .set-del { background: none; border: none; color: var(--neg); font-size: 18px; cursor: pointer; padding: 0; }

    .transfer-card { background: #0a1a0a; border: 1px solid #1a2e1a; border-radius: 16px; padding: 14px; margin-bottom: 10px; }

    .pos { color: var(--pos); } .neg { color: var(--neg); } .muted { color: #555; }
    .hidden { display: none; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const app = initializeApp({
      apiKey: "AIzaSyBYvSsrzjgkrBwhaBAt0KlCGrAtzgOPYx8",
      authDomain: "moneytracker-5335b.firebaseapp.com",
      projectId: "moneytracker-5335b",
      storageBucket: "moneytracker-5335b.firebasestorage.app",
      messagingSenderId: "440589448883",
      appId: "1:440589448883:web:5ad507b270fa414731a2c6"
    });
    window.fbDB = getFirestore(app);
    window.fbMethods = { collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, arrayUnion };
    const auth = getAuth(app);
    window.fbSignIn = () => signInWithPopup(auth, new GoogleAuthProvider());
    window.fbSignOut = () => signOut(auth);
    onAuthStateChanged(auth, user => {
      if (user) {
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("appScreen").style.display = "block";
        document.getElementById("userInfo").textContent = user.displayName || user.email;
        window.fbUser = user;
        if (!window.appStarted) { window.appStarted = true; window.dispatchEvent(new Event("fbReady")); }
      } else {
        document.getElementById("loginScreen").style.display = "flex";
        document.getElementById("appScreen").style.display = "none";
        window.fbUser = null; window.appStarted = false;
      }
    });
  </script>
</head>
<body>

<!-- –õ–û–ì–ò–ù -->
<div id="loginScreen" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#000;text-align:center;padding:20px;">
  <div style="font-size:52px;margin-bottom:16px;">üí∞</div>
  <h2 style="margin-bottom:8px;">–£—á—ë—Ç –ö—É—Ä—å–µ—Ä–∞ Pro</h2>
  <p style="color:#555;margin-bottom:36px;font-size:14px;">–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</p>
  <button onclick="fbSignIn()" style="display:flex;align-items:center;gap:12px;background:#fff;color:#000;border:none;border-radius:14px;padding:15px 28px;font-size:16px;font-weight:bold;cursor:pointer;">
    <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#4285F4" d="M44.5 20H24v8.5h11.8C34.7 33.9 29.8 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 5.1 29.6 3 24 3 12.4 3 3 12.4 3 24s9.4 21 21 21c10.5 0 20-7.6 20-21 0-1.4-.1-2.7-.5-4z"/></svg>
    –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
  </button>
</div>

<!-- –ü–†–ò–õ–û–ñ–ï–ù–ò–ï -->
<div id="appScreen" style="display:none;min-height:100vh;">

  <!-- –®–ê–ü–ö–ê -->
  <div class="top-bar">
    <div class="top-balance">
      <div>
        <div style="font-size:10px;color:#444;margin-bottom:2px;">–ß–ò–°–¢–ê–Ø –ü–†–ò–ë–´–õ–¨</div>
        <div class="top-balance-main" id="balance">0 ‚Ç∏</div>
        <div class="acc-row" id="accountBalances"></div>
      </div>
      <div class="top-balance-side">
        <span>–ü—Ä–∏—Ö–æ–¥</span><b class="pos" id="totalIncome">0 ‚Ç∏</b>
        <span style="margin-top:6px;display:block;">–†–∞—Å—Ö–æ–¥</span><b class="neg" id="totalExpense">0 ‚Ç∏</b>
      </div>
    </div>
    <div class="gas-wrap">
      <div class="gas-label" id="gasText">–ë–µ–Ω–∑–∏–Ω: 0%</div>
      <div class="gas-bar-bg"><div class="gas-bar-fill" id="gasFill"></div></div>
    </div>
  </div>

  <!-- –ü–ï–†–ò–û–î -->
  <div class="period-row">
    <button class="period-btn active" onclick="setRange('today')" id="btn-today">–°–µ–≥–æ–¥–Ω—è</button>
    <button class="period-btn" onclick="setRange('yesterday')" id="btn-yesterday">–í—á–µ—Ä–∞</button>
    <button class="period-btn" onclick="setRange('all')" id="btn-all">–í—Å—ë –≤—Ä–µ–º—è</button>
    <input type="date" id="fromDate" style="display:none;" oninput="render()">
    <input type="date" id="toDate" style="display:none;" oninput="render()">
  </div>

  <!-- –í–ö–õ–ê–î–ö–ò -->
  <div class="page-wrap">

    <!-- 1. –ó–ê–ü–ò–°–¨ -->
    <div class="tab active" id="tab-record">
      <div class="card">
        <div class="card-title">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</div>
        <form id="txForm">
          <div class="row2">
            <select id="type"><option value="income">–ü—Ä–∏—Ö–æ–¥</option><option value="expense">–†–∞—Å—Ö–æ–¥</option></select>
            <select id="accountSelect"></select>
          </div>
          <div class="row2">
            <select id="category"></select>
            <div id="subcatWrap" class="hidden"><select id="subcategory"></select></div>
          </div>
          <div class="row2">
            <input id="amount" type="number" inputmode="decimal" placeholder="–°—É–º–º–∞" required />
            <input id="date" type="date" required />
          </div>
          <input id="comment" type="text" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ" style="margin-bottom:8px;" />
          <div class="chips">
            <button type="button" class="chip" onclick="setAmount(150)">150</button>
            <button type="button" class="chip" onclick="setAmount(300)">300</button>
            <button type="button" class="chip" onclick="setAmount(500)">500</button>
            <button type="button" class="chip" onclick="setAmount(600)">600</button>
            <button type="button" class="chip" onclick="setAmount(1000)">1k</button>
            <button type="button" class="chip" onclick="setAmount(2000)">2k</button>
            <button type="button" class="chip" onclick="setAmount(2500)">2.5k</button>
            <button type="button" class="chip" onclick="setAmount(4500)">4.5k</button>
            <button type="button" class="chip" onclick="setAmount(5000)">5k</button>
          </div>
          <button class="btn-main" type="submit">–ó–∞–ø–∏—Å–∞—Ç—å</button>
        </form>
      </div>
      <div class="card">
        <div class="card-title">–ò—Å—Ç–æ—Ä–∏—è</div>
        <div id="list"><div class="muted">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div></div>
      </div>
    </div>

    <!-- 2. –ü–ï–†–ï–í–û–î–´ + –ù–ê–°–¢–†–û–ô–ö–ò -->
    <div class="tab" id="tab-transfer">
      <div class="transfer-card">
        <div class="card-title" style="color:#65d48b;">üí∏ –ü–µ—Ä–µ–≤–æ–¥</div>
        <div class="row2">
          <select id="transferFrom"></select>
          <select id="transferTo"></select>
        </div>
        <div class="row2">
          <input id="transferAmount" type="number" inputmode="decimal" placeholder="–°—É–º–º–∞" />
          <input id="transferDate" type="date" />
        </div>
        <button class="btn-main" style="background:#0a1f10;color:#65d48b;border:1px solid #1a3a1a;" onclick="doTransfer()">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
      </div>

      <div class="card">
        <div class="card-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div style="margin-bottom:14px;">
          <div class="muted" style="font-size:12px;margin-bottom:6px;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
          <div class="row2">
            <select id="setCatType"><option value="income">–ü—Ä–∏—Ö–æ–¥</option><option value="expense">–†–∞—Å—Ö–æ–¥</option></select>
            <input id="setCatName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
          </div>
          <button class="btn-main" style="background:#222;color:#fff;padding:10px;" onclick="addCategory()">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
        </div>
        <div style="margin-bottom:14px;border-top:1px solid #1a1a1a;padding-top:12px;">
          <div class="muted" style="font-size:12px;margin-bottom:6px;">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</div>
          <div class="row2">
            <select id="setParentCat"></select>
            <input id="setSubName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
          </div>
          <button class="btn-main" style="background:#222;color:#fff;padding:10px;" onclick="addSub()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div style="margin-bottom:14px;border-top:1px solid #1a1a1a;padding-top:12px;">
          <div class="muted" style="font-size:12px;margin-bottom:6px;">–ù–æ–≤—ã–π —Å—á—ë—Ç</div>
          <div class="row2">
            <input id="setAccName" type="text" placeholder="–ù–∞–ø—Ä: Kaspi">
            <button class="btn-main" style="background:#222;color:#fff;padding:10px;margin:0;" onclick="addAccount()">–î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
        </div>
        <div style="margin-bottom:14px;border-top:1px solid #1a1a1a;padding-top:12px;">
          <div class="muted" style="font-size:12px;margin-bottom:6px;">–ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å —Å—á—ë—Ç–∞</div>
          <div class="row2">
            <select id="setBalanceAcc"></select>
            <input id="setBalanceVal" type="number" inputmode="decimal" placeholder="–°—É–º–º–∞ —Å–µ–π—á–∞—Å">
          </div>
          <button class="btn-main" style="background:#222;color:#fff;padding:10px;" onclick="setInitialBalance()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div id="settingsList"></div>
        <div style="border-top:1px solid #1a1a1a;padding-top:12px;margin-top:6px;display:flex;justify-content:space-between;align-items:center;">
          <span id="userInfo" style="font-size:11px;color:#333;"></span>
          <button onclick="fbSignOut()" style="background:none;border:1px solid #222;color:#444;border-radius:8px;padding:5px 12px;font-size:12px;cursor:pointer;">–í—ã–π—Ç–∏</button>
        </div>
      </div>
    </div>

    <!-- 3. –î–û–•–û–î–´ -->
    <div class="tab" id="tab-income">
      <div class="card">
        <div class="card-title">üìà –î–æ—Ö–æ–¥ –ø–æ —Ç–æ—á–∫–∞–º</div>
        <div id="earningsDetails"><div class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></div>
      </div>
      <div class="card" style="border-color:#2a2a1a;">
        <div class="card-title" style="color:var(--accent);">üîÆ –í–æ–∑–º–æ–∂–Ω—ã–π –¥–æ—Ö–æ–¥ (–í–î)</div>
        <div id="potentialStats"><div class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></div>
      </div>
      <div class="card" style="border-color:#1a1a2a;">
        <div class="card-title" style="color:#a78bfa;">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
        <div id="analyticsContent"></div>
      </div>
    </div>

    <!-- 4. –†–ê–°–•–û–î–´ -->
    <div class="tab" id="tab-expense">
      <div class="card">
        <div class="card-title">üìâ –†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
        <div id="expenseDetails"><div class="muted">–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤</div></div>
      </div>
    </div>

  </div>

  <!-- –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ -->
  <nav class="nav-bar">
    <button class="nav-item active" onclick="switchTab('record')" id="nav-record">
      <span class="nav-icon">‚úèÔ∏è</span><span class="nav-label">–ó–∞–ø–∏—Å—å</span>
    </button>
    <button class="nav-item" onclick="switchTab('transfer')" id="nav-transfer">
      <span class="nav-icon">üí∏</span><span class="nav-label">–ü–µ—Ä–µ–≤–æ–¥—ã</span>
    </button>
    <button class="nav-item" onclick="switchTab('income')" id="nav-income">
      <span class="nav-icon">üìà</span><span class="nav-label">–î–æ—Ö–æ–¥—ã</span>
    </button>
    <button class="nav-item" onclick="switchTab('expense')" id="nav-expense">
      <span class="nav-icon">üìâ</span><span class="nav-label">–†–∞—Å—Ö–æ–¥—ã</span>
    </button>
  </nav>

</div>

<script>
  window.switchTab = function(name) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('tab-' + name).classList.add('active');
    document.getElementById('nav-' + name).classList.add('active');
  };
  window.setAmount = function(v) { document.getElementById('amount').value = v; };
</script>

<script>
  let DEFAULTS = { income: [], expense: [] };
  let ACCOUNTS = [];
  let allTx = [];

  let appInitialized = false;
  function tryInitApp() {
    if (appInitialized) return;
    if (window.fbDB && window.fbMethods) { appInitialized = true; initApp(); }
  }
  window.addEventListener("fbReady", tryInitApp);
  const checkFB = setInterval(() => {
    if (window.fbDB && window.fbMethods && window.fbUser) { clearInterval(checkFB); tryInitApp(); }
  }, 200);

  function initApp() {
    const { fbDB, fbMethods } = window;
    const txRef = fbMethods.collection(fbDB, "transactions");
    const setRef = fbMethods.collection(fbDB, "settings");

    const getToday = () => {
      const now = new Date();
      if (now.getHours() < 3) now.setDate(now.getDate() - 1);
      const off = now.getTimezoneOffset() * 60000;
      return new Date(now - off).toISOString().split('T')[0];
    };
    const setToday = () => { document.getElementById("date").value = getToday(); };
    setToday();
    document.getElementById("transferDate").value = getToday();

    window.setRange = (mode) => {
      ['today','yesterday','all'].forEach(m => document.getElementById('btn-'+m).classList.toggle('active', m===mode));
      const today = getToday();
      const f = document.getElementById("fromDate"), t = document.getElementById("toDate");
      if (mode==='today') { f.value=today; t.value=today; }
      else if (mode==='yesterday') {
        const now=new Date(); now.setDate(now.getDate()-1);
        const off=now.getTimezoneOffset()*60000;
        const ys=new Date(now-off).toISOString().split('T')[0];
        f.value=ys; t.value=ys;
      } else { f.value=""; t.value=""; }
      render();
    };

    fbMethods.onSnapshot(setRef, (snap) => {
      DEFAULTS = { income: [], expense: [] }; ACCOUNTS = [];
      let setHtml = "";
      snap.forEach(d => {
        const data = d.data();
        if (data.type === 'category') {
          DEFAULTS[data.catType].push({ id: d.id, ...data });
          const subBtns = (data.sub||[]).map(s=>`<span style="display:inline-flex;align-items:center;gap:3px;background:#2a2a2a;border-radius:5px;padding:2px 7px;margin:2px;font-size:12px;">${s}<button onclick="deleteSub('${d.id}','${s}')" style="background:none;border:none;color:var(--neg);font-size:11px;padding:0;cursor:pointer;line-height:1;">‚úï</button></span>`).join("");
          setHtml += `<div class="set-item"><div class="set-item-top"><span>üìÇ ${data.name} <span style="color:#444;font-size:11px;">${data.catType==='income'?'(+)':'(‚àí)'}</span></span><button class="set-del" onclick="deleteSet('${d.id}')">‚úï</button></div><div style="margin-top:5px;display:flex;flex-wrap:wrap;">${subBtns||'<span style="color:#333;font-size:10px;">–Ω–µ—Ç –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π</span>'}</div></div>`;
        } else if (data.type === 'account') {
          ACCOUNTS.push({ id: d.id, ...data });
          const ib = Number(data.initialBalance)||0;
          setHtml += `<div class="set-item"><div class="set-item-top"><span>üí≥ ${data.name}</span><button class="set-del" onclick="deleteSet('${d.id}')">‚úï</button></div><div style="font-size:10px;color:#333;margin-top:3px;">–ù–∞—á. –±–∞–ª–∞–Ω—Å: ${ib.toLocaleString()} ‚Ç∏</div></div>`;
        }
      });
      document.getElementById("settingsList").innerHTML = setHtml || '<div class="muted" style="font-size:13px;">–ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫</div>';
      updateUI();
    });

    window.addCategory = async () => {
      const name = document.getElementById("setCatName").value.trim();
      const catType = document.getElementById("setCatType").value;
      if (name) await fbMethods.addDoc(setRef, { type:'category', name, catType, sub:[] });
      document.getElementById("setCatName").value = "";
    };
    window.addAccount = async () => {
      const name = document.getElementById("setAccName").value.trim();
      if (name) await fbMethods.addDoc(setRef, { type:'account', name, initialBalance:0 });
      document.getElementById("setAccName").value = "";
    };
    window.setInitialBalance = async () => {
      const accId = document.getElementById("setBalanceAcc").value;
      const val = Number(document.getElementById("setBalanceVal").value);
      if (!accId || isNaN(val)) return;
      await fbMethods.updateDoc(fbMethods.doc(fbDB,"settings",accId), { initialBalance: val });
      document.getElementById("setBalanceVal").value = "";
      alert("–ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!");
    };
    window.addSub = async () => {
      const parentId = document.getElementById("setParentCat").value;
      const subName = document.getElementById("setSubName").value.trim();
      if (parentId && subName) await fbMethods.updateDoc(fbMethods.doc(fbDB,"settings",parentId), { sub: fbMethods.arrayUnion(subName) });
      document.getElementById("setSubName").value = "";
    };
    window.deleteSet = async (id) => { if (confirm("–£–¥–∞–ª–∏—Ç—å?")) await fbMethods.deleteDoc(fbMethods.doc(fbDB,"settings",id)); };
    window.deleteSub = async (catId, subName) => {
      if (confirm(`–£–¥–∞–ª–∏—Ç—å "${subName}"?`)) {
        const cat = [...DEFAULTS.income,...DEFAULTS.expense].find(c=>c.id===catId);
        if (!cat) return;
        await fbMethods.updateDoc(fbMethods.doc(fbDB,"settings",catId), { sub:(cat.sub||[]).filter(s=>s!==subName) });
      }
    };

    function updateUI() {
      const elT=document.getElementById("type"), elC=document.getElementById("category");
      const elS=document.getElementById("subcategory"), elAcc=document.getElementById("accountSelect");
      const sorted=[...ACCOUNTS].sort((a,b)=>a.name.toLowerCase().includes('–Ω–∞–ª–∏—á')?-1:b.name.toLowerCase().includes('–Ω–∞–ª–∏—á')?1:0);
      elAcc.innerHTML = sorted.length ? sorted.map(a=>`<option value="${a.name}">${a.name}</option>`).join("") : '<option value="">–°—á–µ—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω</option>';
      const fromSel=document.getElementById("transferFrom"), toSel=document.getElementById("transferTo");
      if (fromSel&&toSel) { const opts=sorted.map(a=>`<option value="${a.name}">${a.name}</option>`).join(""); fromSel.innerHTML=opts; toSel.innerHTML=opts; if(sorted.length>1)toSel.selectedIndex=1; }
      const balSel=document.getElementById("setBalanceAcc");
      if (balSel) balSel.innerHTML=sorted.map(a=>`<option value="${a.id}">${a.name}</option>`).join("");
      const currentCats=DEFAULTS[elT.value]||[];
      elC.innerHTML=currentCats.map(c=>`<option value="${c.id}">${c.name}</option>`).join("");
      document.getElementById("setParentCat").innerHTML=[...DEFAULTS.income,...DEFAULTS.expense].map(c=>`<option value="${c.id}">${c.name}</option>`).join("");
      const fillSubs=()=>{
        const cat=currentCats.find(c=>c.id===elC.value);
        if(cat&&cat.sub&&cat.sub.length>0){document.getElementById("subcatWrap").classList.remove("hidden");elS.innerHTML=cat.sub.map(s=>`<option value="${s}">${s}</option>`).join("");}
        else{document.getElementById("subcatWrap").classList.add("hidden");elS.innerHTML="";}
      };
      elT.onchange=updateUI; elC.onchange=fillSubs; fillSubs();
    }

    fbMethods.onSnapshot(fbMethods.query(txRef, fbMethods.orderBy("date","desc")), (snap) => {
      allTx = []; snap.forEach(d=>allTx.push({id:d.id,...d.data()}));
      if (!document.getElementById("fromDate").value) setRange('today'); else render();
    });

    document.getElementById("txForm").onsubmit = async (e) => {
      e.preventDefault();
      const amt=Number(document.getElementById("amount").value); if(!amt) return;
      const catId=document.getElementById("category").value;
      const catObj=[...DEFAULTS.income,...DEFAULTS.expense].find(c=>c.id===catId);
      await fbMethods.addDoc(txRef, {
        type:document.getElementById("type").value, amount:amt,
        categoryName:catObj?catObj.name:"–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",
        subcategory:document.getElementById("subcategory").value||"",
        account:document.getElementById("accountSelect").value,
        date:document.getElementById("date").value,
        time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),
        createdAt:Date.now(), comment:document.getElementById("comment").value
      });
      document.getElementById("amount").value=""; document.getElementById("comment").value=""; setToday();
    };
  }

  window.doTransfer = async () => {
    const from=document.getElementById("transferFrom").value, to=document.getElementById("transferTo").value;
    const amt=Number(document.getElementById("transferAmount").value), date=document.getElementById("transferDate").value;
    if(!amt||amt<=0) return alert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É");
    if(from===to) return alert("–°—á–µ—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑–Ω—ã–º–∏");
    if(!date) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É");
    await window.fbMethods.addDoc(window.fbMethods.collection(window.fbDB,"transactions"),{
      type:'transfer',amount:amt,fromAccount:from,toAccount:to,account:from,
      categoryName:`–ü–µ—Ä–µ–≤–æ–¥ ‚Üí ${to}`,subcategory:'',date,
      time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),
      createdAt:Date.now(),comment:`${from} ‚Üí ${to}`
    });
    document.getElementById("transferAmount").value="";
    alert(`–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ ${amt.toLocaleString()} ‚Ç∏`);
  };

  function render() {
    const from=document.getElementById("fromDate").value, to=document.getElementById("toDate").value;
    const filtered=allTx.filter(t=>(!from||t.date>=from)&&(!to||t.date<=to))
      .sort((a,b)=>{ if(b.date!==a.date) return b.date>a.date?1:-1; return(b.createdAt||0)-(a.createdAt||0); });

    const inc=filtered.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
    const exp=filtered.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
    const gas=filtered.filter(t=>t.type==='expense'&&(String(t.subcategory||'').toLowerCase().includes('–±–µ–Ω–∑')||String(t.categoryName||'').toLowerCase().includes('–±–µ–Ω–∑'))).reduce((s,t)=>s+t.amount,0);

    document.getElementById("balance").textContent=(inc-exp).toLocaleString()+" ‚Ç∏";
    document.getElementById("totalIncome").textContent=inc.toLocaleString()+" ‚Ç∏";
    document.getElementById("totalExpense").textContent=exp.toLocaleString()+" ‚Ç∏";

    const accs={};
    ACCOUNTS.forEach(a=>{accs[a.name]=Number(a.initialBalance)||0;});
    allTx.forEach(t=>{
      if(t.type==='transfer'){if(accs[t.fromAccount]!==undefined)accs[t.fromAccount]-=t.amount;if(accs[t.toAccount]!==undefined)accs[t.toAccount]+=t.amount;return;}
      const acc=t.account&&t.account!=='undefined'&&t.account!==''&&t.account!=='–°—á–µ—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω'?t.account:null;
      if(!acc)return; if(accs[acc]===undefined)accs[acc]=0;
      accs[acc]+=(t.type==='income'?t.amount:-t.amount);
    });
    document.getElementById("accountBalances").innerHTML=Object.entries(accs)
      .filter(([n])=>n&&n!=='undefined'&&n!=='–°—á–µ—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω')
      .map(([n,v])=>`<span>${n}: <b style="color:${v>=0?'#65d48b':'#ff6b6b'}">${v.toLocaleString()}</b></span>`).join(" ¬∑ ");

    const gasP=inc>0?((gas/inc)*100).toFixed(1):0;
    document.getElementById("gasText").textContent=`–ë–µ–Ω–∑–∏–Ω: ${gasP}% (${gas.toLocaleString()} ‚Ç∏)`;
    document.getElementById("gasFill").style.width=Math.min(Number(gasP)*3,100)+"%";

    const statsInc={};
    filtered.filter(t=>t.type==='income').forEach(t=>{
      const key=t.subcategory||t.categoryName;
      if(!statsInc[key])statsInc[key]={sum:0,cnt:0,br:{}};
      statsInc[key].sum+=t.amount;statsInc[key].cnt++;statsInc[key].br[t.amount]=(statsInc[key].br[t.amount]||0)+1;
    });
    document.getElementById("earningsDetails").innerHTML=Object.entries(statsInc).map(([k,d])=>`
      <div class="stat-row"><div class="stat-main"><span>${k} (${d.cnt})</span><b>${d.sum.toLocaleString()} ‚Ç∏</b></div>
      <div class="stat-sub">${Object.entries(d.br).map(([p,c])=>`${p}‚Ç∏√ó${c}`).join(" | ")}</div></div>`).join("")||'<div class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';

    let totalGain=0; const vdStats={}, vds=["F1","F2","F3","–ù–æ—á—å"];
    filtered.forEach(t=>{
      if(t.type==='income'&&vds.includes(t.subcategory)&&t.amount<3000){
        if(!vdStats[t.subcategory])vdStats[t.subcategory]={vdSum:0};
        let p=t.amount;
        if(t.amount===150)p=600;else if(t.amount===300)p=900;else if(t.subcategory==="–ù–æ—á—å"&&t.amount===500)p=1000;
        vdStats[t.subcategory].vdSum+=p;
      }
    });
    const vdHtml=Object.entries(vdStats).map(([p,data])=>{
      const rSum=statsInc[p]?statsInc[p].sum:0, diff=data.vdSum-rSum; totalGain+=diff;
      return`<div class="stat-row"><div class="stat-main"><span>${p}</span><b>${data.vdSum.toLocaleString()} ‚Ç∏</b></div><div style="color:#65d48b;font-size:12px;">–í—ã–≥–æ–¥–∞: +${diff.toLocaleString()} ‚Ç∏</div></div>`;
    }).join("");
    document.getElementById("potentialStats").innerHTML=vdHtml||'<div class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –í–î</div>';
    if(totalGain>0)document.getElementById("potentialStats").innerHTML+=`<div class="gain-box"><span>–í–´–ì–û–î–ê –í–î:</span><span class="pos">+${totalGain.toLocaleString()} ‚Ç∏</span></div>`;

    const statsExp={};
    filtered.filter(t=>t.type==='expense').forEach(t=>{
      if(!statsExp[t.categoryName])statsExp[t.categoryName]={sum:0,subs:{}};
      statsExp[t.categoryName].sum+=t.amount;
      if(t.subcategory)statsExp[t.categoryName].subs[t.subcategory]=(statsExp[t.categoryName].subs[t.subcategory]||0)+t.amount;
    });
    document.getElementById("expenseDetails").innerHTML=Object.entries(statsExp).map(([c,d])=>`
      <div class="stat-row"><div class="stat-main"><span>${c}</span><b class="neg">${d.sum.toLocaleString()} ‚Ç∏</b></div>
      <div class="stat-sub">${Object.entries(d.subs).map(([s,v])=>`${s}: ${v.toLocaleString()}`).join(" | ")}</div></div>`).join("")||'<div class="muted">–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤</div>';

    document.getElementById("list").innerHTML=filtered.map(t=>{
      const acc=t.account&&t.account!=='undefined'&&t.account!==''&&t.account!=='–°—á–µ—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω'?` [${t.account}]`:'';
      const ts=t.time?`${t.date} ${t.time}`:t.date;
      if(t.type==='transfer')return`<div class="hist-item"><div><b style="color:#ffd166;">‚Üî ${t.amount.toLocaleString()} ‚Ç∏</b><br><small class="muted">${ts} | ${t.fromAccount} ‚Üí ${t.toAccount}</small></div><button class="hist-del" onclick="deleteTx('${t.id}')">‚úï</button></div>`;
      return`<div class="hist-item"><div><b class="${t.type==='income'?'pos':'neg'}">${t.amount.toLocaleString()} ‚Ç∏</b><br><small class="muted">${ts} | ${t.subcategory||t.categoryName}${acc}</small>${t.comment?`<div style="color:#65d48b;font-size:11px;margin-top:2px;">üìù ${t.comment}</div>`:''}</div><button class="hist-del" onclick="deleteTx('${t.id}')">‚úï</button></div>`;
    }).join("")||'<div class="muted">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';

    renderAnalytics();
  }

  window.render = render;

  function renderAnalytics() {
    const el=document.getElementById("analyticsContent"); if(!el)return;
    const byDay={},byMonth={};
    allTx.forEach(t=>{ if(t.type!=='income')return; const d=t.date||'',m=d.slice(0,7); if(!byDay[d])byDay[d]=0;byDay[d]+=t.amount; if(!byMonth[m])byMonth[m]={inc:0,exp:0};byMonth[m].inc+=t.amount; });
    allTx.forEach(t=>{ if(t.type!=='expense')return; const m=(t.date||'').slice(0,7); if(!byMonth[m])byMonth[m]={inc:0,exp:0};byMonth[m].exp+=t.amount; });

    const deliveryDays=new Set();
    allTx.forEach(t=>{if(t.type==='income'&&["F1","F2","F3","–ù–æ—á—å"].includes(t.subcategory))deliveryDays.add(t.date);});
    const days=Object.entries(byDay).filter(([d])=>d);
    let bestDay=null,worstDay=null;
    if(days.length>0){bestDay=days.reduce((a,b)=>b[1]>a[1]?b:a);const dl=days.filter(([d])=>deliveryDays.has(d));if(dl.length>0)worstDay=dl.reduce((a,b)=>b[1]<a[1]?b:a);}

    const fmtD=d=>{if(!d)return'‚Äî';const[y,mo,day]=d.split('-');return`${day}.${mo}.${y}`;};
    const fmtM=m=>{if(!m)return'‚Äî';const mn=['–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'];const[y,mo]=m.split('-');return`${mn[parseInt(mo)-1]} ${y}`;};

    const from=document.getElementById("fromDate").value,to=document.getElementById("toDate").value;
    const filteredDays=Object.entries(byDay).filter(([d])=>d&&(!from||d>=from)&&(!to||d<=to)).sort((a,b)=>a[0]>b[0]?1:-1);

    let chartHtml='',chartData=null;
    if(filteredDays.length>1){
      const maxVal=Math.max(...filteredDays.map(([,v])=>v)),W=Math.max(filteredDays.length*50,300),H=80,pad=10;
      chartData={filteredDays,maxVal,W,H,pad};
      chartHtml=`<div class="sec-title">–ì—Ä–∞—Ñ–∏–∫ –¥–æ—Ö–æ–¥–∞ –ø–æ –¥–Ω—è–º</div><div style="text-align:center;height:24px;display:flex;align-items:center;justify-content:center;gap:8px;"><span id="chartTipDate" style="font-size:11px;color:#555;"></span><span id="chartTipVal" style="font-size:15px;font-weight:bold;color:#a78bfa;"></span></div><div class="chart-wrap"><canvas id="incomeChart" width="${W}" height="${H+20}" style="display:block;"></canvas></div>`;
    }

    const bwHtml=bestDay?`<div class="sec-title">–õ—É—á—à–∏–π –∏ —Ö—É–¥—à–∏–π –¥–µ–Ω—å</div><div class="bw-grid"><div class="bw-card best"><div class="bw-label">üèÜ –õ—É—á—à–∏–π</div><div class="bw-val pos">${bestDay[1].toLocaleString()} ‚Ç∏</div><div class="bw-date">${fmtD(bestDay[0])}</div></div><div class="bw-card worst"><div class="bw-label">üìâ –•—É–¥—à–∏–π</div><div class="bw-val neg">${worstDay?worstDay[1].toLocaleString():'‚Äî'} ‚Ç∏</div><div class="bw-date">${worstDay?fmtD(worstDay[0]):'‚Äî'}</div></div></div>`:'';

    const wdByM={};
    allTx.forEach(t=>{if(t.type==='income'&&["F1","F2","F3","–ù–æ—á—å"].includes(t.subcategory)){const m=(t.date||'').slice(0,7);if(!wdByM[m])wdByM[m]=new Set();wdByM[m].add(t.date);}});
    const sortedM=Object.entries(byMonth).sort((a,b)=>b[0]>a[0]?1:-1).slice(0,6);
    const maxInc=Math.max(...sortedM.map(([,d])=>d.inc),1);
    const monthHtml=sortedM.length>0?`<div class="sec-title">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –º–µ—Å—è—Ü–∞–º</div>${sortedM.map(([m,d])=>{const wd=wdByM[m]?wdByM[m].size:0,avg=wd>0?Math.round(d.inc/wd):0;return`<div class="month-row"><div class="month-top"><span>${fmtM(m)}</span><span class="pos">${d.inc.toLocaleString()} ‚Ç∏</span></div><div class="month-bar-bg"><div class="month-bar-fill" style="width:${(d.inc/maxInc*100).toFixed(1)}%"></div></div><div class="month-meta">üìÖ ${wd} –¥–Ω. ¬∑ ‚âà ${avg.toLocaleString()} ‚Ç∏/–¥–µ–Ω—å</div></div>`;}).join('')}`:'';

    el.innerHTML=chartHtml+bwHtml+monthHtml||'<div class="muted">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö</div>';

    if(chartData){
      const{filteredDays,maxVal,W,H,pad}=chartData;
      const canvas=document.getElementById('incomeChart'); if(!canvas)return;
      const ctx=canvas.getContext('2d');
      const getX=i=>pad+i*((W-pad*2)/(filteredDays.length-1));
      const getY=v=>H-pad-((v/maxVal)*(H-pad*2));
      function draw(ai){
        ctx.clearRect(0,0,W,H+20);
        const g=ctx.createLinearGradient(0,0,0,H);g.addColorStop(0,'rgba(167,139,250,0.2)');g.addColorStop(1,'rgba(167,139,250,0)');
        ctx.beginPath();ctx.moveTo(getX(0),getY(filteredDays[0][1]));filteredDays.forEach(([,v],i)=>ctx.lineTo(getX(i),getY(v)));
        ctx.lineTo(getX(filteredDays.length-1),H);ctx.lineTo(getX(0),H);ctx.closePath();ctx.fillStyle=g;ctx.fill();
        ctx.beginPath();ctx.strokeStyle='#a78bfa';ctx.lineWidth=2.5;ctx.lineJoin='round';
        ctx.moveTo(getX(0),getY(filteredDays[0][1]));filteredDays.forEach(([,v],i)=>ctx.lineTo(getX(i),getY(v)));ctx.stroke();
        filteredDays.forEach(([,v],i)=>{
          const x=getX(i),y=getY(v);
          if(i===ai){ctx.beginPath();ctx.strokeStyle='rgba(167,139,250,0.25)';ctx.lineWidth=1;ctx.setLineDash([4,3]);ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();ctx.setLineDash([]);ctx.beginPath();ctx.arc(x,y,7,0,Math.PI*2);ctx.fillStyle='rgba(167,139,250,0.15)';ctx.fill();ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();ctx.beginPath();ctx.arc(x,y,2.5,0,Math.PI*2);ctx.fillStyle='#a78bfa';ctx.fill();}
          else{ctx.beginPath();ctx.arc(x,y,3,0,Math.PI*2);ctx.fillStyle='#a78bfa';ctx.fill();}
        });
        ctx.fillStyle='#3a3a3a';ctx.font='9px sans-serif';ctx.textAlign='center';
        filteredDays.forEach(([d,],i)=>ctx.fillText(d.slice(8),getX(i),H+14));
      }
      const getIdx=cx=>{const r=canvas.getBoundingClientRect(),mx=(cx-r.left)*(W/r.width);let cl=0,md=Infinity;filteredDays.forEach(([,],i)=>{const dist=Math.abs(getX(i)-mx);if(dist<md){md=dist;cl=i;}});return cl;};
      const showTip=idx=>{const[d,v]=filteredDays[idx];document.getElementById('chartTipDate').textContent=d.slice(8)+'.'+d.slice(5,7);document.getElementById('chartTipVal').textContent=v.toLocaleString()+' ‚Ç∏';draw(idx);};
      const hideTip=()=>{document.getElementById('chartTipDate').textContent='';document.getElementById('chartTipVal').textContent='';draw(-1);};
      canvas.addEventListener('touchstart',e=>showTip(getIdx(e.touches[0].clientX)),{passive:true});
      canvas.addEventListener('touchend',()=>hideTip());
      canvas.addEventListener('mousemove',e=>showTip(getIdx(e.clientX)));
      canvas.addEventListener('mouseleave',()=>hideTip());
      draw(-1);
    }
  }

  window.deleteTx = async (id) => {
    if(confirm("–£–¥–∞–ª–∏—Ç—å?")) await window.fbMethods.deleteDoc(window.fbMethods.doc(window.fbDB,"transactions",id));
  };
</script>
</body>
</html>
