<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>–£—á—ë—Ç –ö—É—Ä—å–µ—Ä–∞ Pro</title>
  <style>
    :root { --bg: #000; --card: #1c1c1e; --text: #fff; --pos: #65d48b; --neg: #ff6b6b; --accent: #ffd166; }
    * { box-sizing: border-box; font-family: -apple-system, sans-serif; }
    body { background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
    .wrap { max-width: 500px; margin: 0 auto; }
    .card { background: var(--card); border-radius: 16px; padding: 15px; margin-bottom: 12px; border: 1px solid #222; }
    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #333; background: #2c2c2e; color: #fff; font-size: 16px; outline: none; }
    .btn-main { width: 100%; padding: 14px; border: none; border-radius: 10px; background: var(--pos); color: #000; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }
    .scroll-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; scrollbar-width: none; }
    .scroll-container::-webkit-scrollbar { display: none; }
    .chip { flex: 0 0 auto; background: #333; color: var(--accent); padding: 8px 14px; border-radius: 8px; font-weight: bold; border: none; font-size: 14px; cursor: pointer; }
    .chip-period { color: #fff; background: #2c2c2e; border: 1px solid #444; font-size: 13px; }
    .gas-box { margin-top: 10px; font-size: 11px; }
    .gas-bar { height: 4px; background: #333; border-radius: 2px; margin: 4px 0; overflow: hidden; }
    .gas-fill { height: 100%; background: var(--accent); width: 0%; transition: 0.3s; }
    .collapsible-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 5px 0; }
    .arrow { font-size: 12px; color: #666; }
    .hidden { display: none; }
    .balance-line { display: flex; justify-content: space-between; text-align: center; margin-bottom: 10px; }
    .pos { color: var(--pos); } .neg { color: var(--neg); } .muted { color: #888; }
    .stat-row { border-bottom: 1px solid #222; padding: 12px 0; }
    .stat-main { display: flex; justify-content: space-between; width: 100%; font-size: 16px; font-weight: bold; }
    .stat-sub { font-size: 11px; color: #777; margin-top: 4px; }
    .item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #333; align-items: flex-start; }
    .set-item { background: #2c2c2e; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 14px; }
    .set-item button { background: none; border: none; color: var(--neg); float: right; font-size: 16px; cursor: pointer; }
    .gain-box { background: #1a2e21; padding: 15px; border-radius: 12px; border: 1px solid var(--pos); margin-top: 15px; display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; }
  </style>

  <!-- Firebase ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBYvSsrzjgkrBwhaBAt0KlCGrAtzgOPYx8",
      authDomain: "moneytracker-5335b.firebaseapp.com",
      projectId: "moneytracker-5335b",
      storageBucket: "moneytracker-5335b.firebasestorage.app",
      messagingSenderId: "440589448883",
      appId: "1:440589448883:web:5ad507b270fa414731a2c6"
    };

    const app = initializeApp(firebaseConfig);
    window.fbDB = getFirestore(app);
    window.fbMethods = { collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, arrayUnion };
  </script>
</head>
<body>
  <div class="wrap">

    <!-- –§–û–†–ú–ê –ó–ê–ü–ò–°–ò -->
    <section class="card">
      <form id="txForm">
        <div class="row2">
          <select id="type"><option value="income">–ü—Ä–∏—Ö–æ–¥</option><option value="expense">–†–∞—Å—Ö–æ–¥</option></select>
          <select id="accountSelect"></select>
        </div>
        <div class="row2">
          <select id="category"></select>
          <div id="subcatWrap" class="hidden"><select id="subcategory"></select></div>
        </div>
        <div class="row2">
          <input id="amount" type="number" inputmode="decimal" placeholder="–°—É–º–º–∞" required />
          <input id="date" type="date" required />
        </div>
        <input id="comment" type="text" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ" style="margin-bottom:10px;" />
        <div class="scroll-container">
          <button type="button" class="chip" onclick="setAmount(150)">150</button>
          <button type="button" class="chip" onclick="setAmount(300)">300</button>
          <button type="button" class="chip" onclick="setAmount(500)">500</button>
          <button type="button" class="chip" onclick="setAmount(600)">600</button>
          <button type="button" class="chip" onclick="setAmount(1000)">1000</button>
          <button type="button" class="chip" onclick="setAmount(2000)">2k</button>
          <button type="button" class="chip" onclick="setAmount(2500)">2.5k</button>
          <button type="button" class="chip" onclick="setAmount(4500)">4.5k</button>
          <button type="button" class="chip" onclick="setAmount(5000)">5k</button>
        </div>
        <button class="btn-main" type="submit">–ó–∞–ø–∏—Å–∞—Ç—å</button>
      </form>
    </section>

    <!-- –ë–ê–õ–ê–ù–° –ò –ü–ï–†–ò–û–î -->
    <section class="card">
      <div class="collapsible-header" onclick="toggleBlock(this)"><h3>üí∞ –ë–∞–ª–∞–Ω—Å –∏ –ü–µ—Ä–∏–æ–¥</h3><span class="arrow">‚ñ≤</span></div>
      <div class="content">
        <div class="balance-line">
          <div><small class="muted">–ß–∏—Å—Ç–∞—è</small><br><b id="balance" style="font-size: 20px;">0 ‚Ç∏</b></div>
          <div><small class="muted">–ü—Ä–∏—Ö–æ–¥</small><br><b id="totalIncome" class="pos">0 ‚Ç∏</b></div>
          <div><small class="muted">–†–∞—Å—Ö–æ–¥</small><br><b id="totalExpense" class="neg">0 ‚Ç∏</b></div>
        </div>
        <div id="accountBalances" style="font-size:11px; margin-bottom:12px; color:#aaa; display:flex; gap:10px; flex-wrap:wrap;"></div>
        <div class="gas-box">
          <div id="gasText" style="color:#888;">–ë–µ–Ω–∑–∏–Ω: 0%</div>
          <div class="gas-bar"><div id="gasFill" class="gas-fill"></div></div>
        </div>
        <div class="row2" style="margin-top:15px;">
          <input type="date" id="fromDate">
          <input type="date" id="toDate">
        </div>
        <div class="scroll-container">
          <button type="button" class="chip chip-period" onclick="setRange('today')">–°–µ–≥–æ–¥–Ω—è</button>
          <button type="button" class="chip chip-period" onclick="setRange('yesterday')">–í—á–µ—Ä–∞</button>
          <button type="button" class="chip chip-period" onclick="setRange('all')">–í—Å–µ –≤—Ä–µ–º—è</button>
        </div>
      </div>
    </section>

    <!-- –î–û–•–û–î –ü–û –¢–û–ß–ö–ê–ú -->
    <section class="card">
      <div class="collapsible-header" onclick="toggleBlock(this)"><h3>üìà –î–æ—Ö–æ–¥ –ø–æ —Ç–æ—á–∫–∞–º</h3><span class="arrow">‚ñ≤</span></div>
      <div id="earningsDetails" class="content"></div>
    </section>

    <!-- –í–û–ó–ú–û–ñ–ù–´–ô –î–û–•–û–î -->
    <section class="card" style="border: 1px solid #444;">
      <div class="collapsible-header" onclick="toggleBlock(this)"><h3 style="color:var(--accent)">üîÆ –í–æ–∑–º–æ–∂–Ω—ã–π –¥–æ—Ö–æ–¥</h3><span class="arrow">‚ñ≤</span></div>
      <div id="potentialStats" class="content"></div>
    </section>

    <!-- –†–ê–°–•–û–î–´ –ü–û –ö–ê–¢–ï–ì–û–†–ò–Ø–ú -->
    <section class="card">
      <div class="collapsible-header" onclick="toggleBlock(this)"><h3>üìâ –†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3><span class="arrow">‚ñº</span></div>
      <div id="expenseDetails" class="content hidden"></div>
    </section>

    <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
    <section class="card" style="border: 1px solid #333;">
      <div class="collapsible-header" onclick="toggleBlock(this)"><h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3><span class="arrow">‚ñº</span></div>
      <div class="content hidden">
        <div style="margin-bottom:15px;">
          <small class="muted">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</small>
          <div class="row2" style="margin-top:5px;">
            <select id="setCatType"><option value="income">–ü—Ä–∏—Ö–æ–¥</option><option value="expense">–†–∞—Å—Ö–æ–¥</option></select>
            <input id="setCatName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
          </div>
          <button class="btn-main" style="background:#444; color:#fff; padding:8px;" onclick="addCategory()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div style="margin-bottom:15px; border-top:1px solid #222; padding-top:10px;">
          <small class="muted">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è:</small>
          <div class="row2" style="margin-top:5px;">
            <select id="setParentCat"></select>
            <input id="setSubName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
          </div>
          <button class="btn-main" style="background:#444; color:#fff; padding:8px;" onclick="addSub()">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∫–∞—Ç.</button>
        </div>
        <div style="margin-bottom:15px; border-top:1px solid #222; padding-top:10px;">
          <small class="muted">–°—á–µ—Ç:</small>
          <div class="row2" style="margin-top:5px;">
            <input id="setAccName" type="text" placeholder="–ù–∞–ø—Ä: –ö–∞—Å–ø–∏">
            <button class="btn-main" style="background:#444; color:#fff; padding:8px; margin:0;" onclick="addAccount()">–û–ö</button>
          </div>
        </div>
        <div id="settingsList" style="margin-top:15px;"></div>
      </div>
    </section>

    <!-- –ò–°–¢–û–†–ò–Ø -->
    <section class="card">
      <div class="collapsible-header" onclick="toggleBlock(this)"><h3>üìù –ò—Å—Ç–æ—Ä–∏—è</h3><span class="arrow">‚ñº</span></div>
      <div id="list" class="content hidden"></div>
    </section>

  </div>

  <script>
    window.toggleBlock = function(el) {
      const content = el.nextElementSibling;
      content.classList.toggle('hidden');
      el.querySelector('.arrow').textContent = content.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
    };
    window.setAmount = function(v) { document.getElementById('amount').value = v; };
  </script>

  <script>
    let DEFAULTS = { income: [], expense: [] };
    let ACCOUNTS = [];
    let allTx = [];

    // –ñ–¥—ë–º –ø–æ–∫–∞ Firebase –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ module script
    const checkFB = setInterval(() => {
      if (window.fbDB && window.fbMethods) { clearInterval(checkFB); initApp(); }
    }, 100);

    function initApp() {
      const { fbDB, fbMethods } = window;
      const txRef = fbMethods.collection(fbDB, "transactions");
      const setRef = fbMethods.collection(fbDB, "settings");

      const setToday = () => {
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000;
        const local = new Date(now - offset).toISOString().split('T')[0];
        document.getElementById("date").value = local;
        return local;
      };
      setToday();

      document.getElementById("fromDate").oninput = render;
      document.getElementById("toDate").oninput = render;

      // –ù–ê–°–¢–†–û–ô–ö–ò ‚Äî —Å–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
      fbMethods.onSnapshot(setRef, (snap) => {
        DEFAULTS = { income: [], expense: [] };
        ACCOUNTS = [];
        let setHtml = "";

        snap.forEach(d => {
          const data = d.data();
          if (data.type === 'category') {
            DEFAULTS[data.catType].push({ id: d.id, ...data });
            setHtml += `<div class="set-item">üìÇ ${data.name} (${data.catType === 'income' ? '+' : '-'})
              <button onclick="deleteSet('${d.id}')">‚úï</button>
              <div style="font-size:10px;color:#666;">${(data.sub || []).join(", ")}</div>
            </div>`;
          } else if (data.type === 'account') {
            ACCOUNTS.push({ id: d.id, ...data });
            setHtml += `<div class="set-item">üí≥ ${data.name} <button onclick="deleteSet('${d.id}')">‚úï</button></div>`;
          }
        });

        document.getElementById("settingsList").innerHTML = setHtml || '<div class="muted">–ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫</div>';
        updateUI();
      });

      window.addCategory = async () => {
        const name = document.getElementById("setCatName").value.trim();
        const catType = document.getElementById("setCatType").value;
        if (name) await fbMethods.addDoc(setRef, { type: 'category', name, catType, sub: [] });
        document.getElementById("setCatName").value = "";
      };

      window.addAccount = async () => {
        const name = document.getElementById("setAccName").value.trim();
        if (name) await fbMethods.addDoc(setRef, { type: 'account', name });
        document.getElementById("setAccName").value = "";
      };

      window.addSub = async () => {
        const parentId = document.getElementById("setParentCat").value;
        const subName = document.getElementById("setSubName").value.trim();
        if (parentId && subName) {
          await fbMethods.updateDoc(fbMethods.doc(fbDB, "settings", parentId), {
            sub: fbMethods.arrayUnion(subName)
          });
        }
        document.getElementById("setSubName").value = "";
      };

      window.deleteSet = async (id) => {
        if (confirm("–£–¥–∞–ª–∏—Ç—å?")) await fbMethods.deleteDoc(fbMethods.doc(fbDB, "settings", id));
      };

      function updateUI() {
        const elT = document.getElementById("type");
        const elC = document.getElementById("category");
        const elS = document.getElementById("subcategory");
        const elAcc = document.getElementById("accountSelect");

        elAcc.innerHTML = ACCOUNTS.length
          ? ACCOUNTS.map(a => `<option value="${a.name}">${a.name}</option>`).join("")
          : '<option value="">–°—á–µ—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω</option>';

        const currentCats = DEFAULTS[elT.value] || [];
        elC.innerHTML = currentCats.map(c => `<option value="${c.id}">${c.name}</option>`).join("");

        document.getElementById("setParentCat").innerHTML = [...DEFAULTS.income, ...DEFAULTS.expense]
          .map(c => `<option value="${c.id}">${c.name}</option>`).join("");

        const fillSubs = () => {
          const cat = currentCats.find(c => c.id === elC.value);
          if (cat && cat.sub && cat.sub.length > 0) {
            document.getElementById("subcatWrap").classList.remove("hidden");
            elS.innerHTML = cat.sub.map(s => `<option value="${s}">${s}</option>`).join("");
          } else {
            document.getElementById("subcatWrap").classList.add("hidden");
            elS.innerHTML = "";
          }
        };

        elT.onchange = updateUI;
        elC.onchange = fillSubs;
        fillSubs();
      }

      // –¢–†–ê–ù–ó–ê–ö–¶–ò–ò ‚Äî —Å–ª—É—à–∞–µ–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
      fbMethods.onSnapshot(fbMethods.query(txRef, fbMethods.orderBy("date", "desc")), (snap) => {
        allTx = [];
        snap.forEach(d => allTx.push({ id: d.id, ...d.data() }));
        if (!document.getElementById("fromDate").value) setRange('today');
        else render();
      });

      // –§–û–†–ú–ê
      document.getElementById("txForm").onsubmit = async (e) => {
        e.preventDefault();
        const amt = Number(document.getElementById("amount").value);
        if (!amt) return;
        const catId = document.getElementById("category").value;
        const catObj = [...DEFAULTS.income, ...DEFAULTS.expense].find(c => c.id === catId);
        await fbMethods.addDoc(txRef, {
          type: document.getElementById("type").value,
          amount: amt,
          categoryName: catObj ? catObj.name : "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",
          subcategory: document.getElementById("subcategory").value || "",
          account: document.getElementById("accountSelect").value,
          date: document.getElementById("date").value,
          time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
          createdAt: Date.now(),
          comment: document.getElementById("comment").value
        });
        document.getElementById("amount").value = "";
        document.getElementById("comment").value = "";
        setToday();
      };
    }

    // –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ü–ï–†–ò–û–î–ê
    window.setRange = (mode) => {
      const f = document.getElementById("fromDate");
      const t = document.getElementById("toDate");
      const now = new Date();
      const offset = now.getTimezoneOffset() * 60000;
      const today = new Date(now - offset).toISOString().split('T')[0];

      if (mode === 'today') {
        f.value = today; t.value = today;
      } else if (mode === 'yesterday') {
        const y = new Date(now - offset);
        y.setDate(y.getDate() - 1);
        const yStr = y.toISOString().split('T')[0];
        f.value = yStr; t.value = yStr;
      } else {
        f.value = ""; t.value = "";
      }
      render();
    };

    // –†–ï–ù–î–ï–†
    function render() {
      const from = document.getElementById("fromDate").value;
      const to = document.getElementById("toDate").value;
      const filtered = allTx.filter(t => (!from || t.date >= from) && (!to || t.date <= to));

      const inc = filtered.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
      const exp = filtered.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
      const gas = filtered.filter(t => t.type === 'expense' && (
        String(t.subcategory || '').toLowerCase().includes('–±–µ–Ω–∑') ||
        String(t.categoryName || '').toLowerCase().includes('–±–µ–Ω–∑')
      )).reduce((s, t) => s + t.amount, 0);

      document.getElementById("balance").textContent = (inc - exp).toLocaleString() + " ‚Ç∏";
      document.getElementById("totalIncome").textContent = inc.toLocaleString() + " ‚Ç∏";
      document.getElementById("totalExpense").textContent = exp.toLocaleString() + " ‚Ç∏";

      // –ë–∞–ª–∞–Ω—Å –ø–æ —Å—á–µ—Ç–∞–º
      const accs = {};
      filtered.forEach(t => {
        const acc = t.account && t.account !== 'undefined' ? t.account : null;
        if (!acc) return;
        if (!accs[acc]) accs[acc] = 0;
        accs[acc] += (t.type === 'income' ? t.amount : -t.amount);
      });
      document.getElementById("accountBalances").innerHTML = Object.entries(accs)
        .map(([n, v]) => `<span>${n}: <b style="color:${v >= 0 ? '#65d48b' : '#ff6b6b'}">${v.toLocaleString()}</b></span>`)
        .join(" | ");

      const gasP = inc > 0 ? ((gas / inc) * 100).toFixed(1) : 0;
      document.getElementById("gasText").textContent = `–ë–µ–Ω–∑–∏–Ω: ${gasP}% (${gas.toLocaleString()} ‚Ç∏)`;
      document.getElementById("gasFill").style.width = Math.min(Number(gasP) * 3, 100) + "%";

      // –î–æ—Ö–æ–¥ –ø–æ —Ç–æ—á–∫–∞–º
      const statsInc = {};
      filtered.filter(t => t.type === 'income').forEach(t => {
        const key = t.subcategory || t.categoryName;
        if (!statsInc[key]) statsInc[key] = { sum: 0, cnt: 0, br: {} };
        statsInc[key].sum += t.amount;
        statsInc[key].cnt++;
        statsInc[key].br[t.amount] = (statsInc[key].br[t.amount] || 0) + 1;
      });
      document.getElementById("earningsDetails").innerHTML = Object.entries(statsInc).map(([k, d]) => `
        <div class="stat-row">
          <div class="stat-main"><span>${k} (${d.cnt})</span><b>${d.sum.toLocaleString()} ‚Ç∏</b></div>
          <div class="stat-sub">${Object.entries(d.br).map(([p, c]) => `${p}‚Ç∏√ó${c}`).join(" | ")}</div>
        </div>`).join("") || '<div class="muted" style="padding:10px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';

      // –í–æ–∑–º–æ–∂–Ω—ã–π –¥–æ—Ö–æ–¥
      let totalGain = 0;
      const vdStats = {};
      const vds = ["F1", "F2", "F3", "–ù–æ—á—å"];

      // –°—á–∏—Ç–∞–µ–º –í–î —Ç–æ–ª—å–∫–æ –ø–æ –∑–∞–ø–∏—Å—è–º < 3000
      filtered.forEach(t => {
        if (t.type === 'income' && vds.includes(t.subcategory) && t.amount < 3000) {
          if (!vdStats[t.subcategory]) vdStats[t.subcategory] = { vdSum: 0 };
          let p = t.amount;
          if (t.amount === 150) p = 600;
          else if (t.amount === 300) p = 900;
          else if (t.subcategory === "–ù–æ—á—å" && t.amount === 500) p = 1000;
          vdStats[t.subcategory].vdSum += p;
        }
      });

      const vdHtml = Object.entries(vdStats).map(([p, data]) => {
        // –í—ã—á–∏—Ç–∞–µ–º –í–°–ï —Ä–µ–∞–ª—å–Ω—ã–µ –¥–æ—Ö–æ–¥—ã —Å —ç—Ç–æ–π —Ç–æ—á–∫–∏ (–≤–∫–ª—é—á–∞—è ‚â•3000)
        const rSum = statsInc[p] ? statsInc[p].sum : 0;
        const diff = data.vdSum - rSum;
        totalGain += diff;
        return `<div class="stat-row">
          <div class="stat-main"><span>${p}</span><b>${data.vdSum.toLocaleString()} ‚Ç∏</b></div>
          <div style="color:#65d48b;font-size:12px;">–í—ã–≥–æ–¥–∞: +${diff.toLocaleString()} ‚Ç∏</div>
        </div>`;
      }).join("");
      document.getElementById("potentialStats").innerHTML = vdHtml || '<div class="muted" style="padding:10px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –í–î</div>';
      if (totalGain > 0) {
        document.getElementById("potentialStats").innerHTML +=
          `<div class="gain-box"><span>–í–´–ì–û–î–ê –í–î:</span><span class="pos">+${totalGain.toLocaleString()} ‚Ç∏</span></div>`;
      }

      // –†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
      const statsExp = {};
      filtered.filter(t => t.type === 'expense').forEach(t => {
        if (!statsExp[t.categoryName]) statsExp[t.categoryName] = { sum: 0, subs: {} };
        statsExp[t.categoryName].sum += t.amount;
        if (t.subcategory) statsExp[t.categoryName].subs[t.subcategory] = (statsExp[t.categoryName].subs[t.subcategory] || 0) + t.amount;
      });
      document.getElementById("expenseDetails").innerHTML = Object.entries(statsExp).map(([c, d]) => `
        <div class="stat-row">
          <div class="stat-main"><span>${c}</span><b class="neg">${d.sum.toLocaleString()} ‚Ç∏</b></div>
          <div class="stat-sub">${Object.entries(d.subs).map(([s, v]) => `${s}: ${v.toLocaleString()}`).join(" | ")}</div>
        </div>`).join("") || '<div class="muted" style="padding:10px;">–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤</div>';

      // –ò—Å—Ç–æ—Ä–∏—è
      document.getElementById("list").innerHTML = filtered.map(t => {
        const acc = t.account && t.account !== 'undefined' && t.account !== '' ? ` [${t.account}]` : '';
        const timeStr = t.time ? `${t.date} ${t.time}` : t.date;
        return `<div class="item">
          <div>
            <b class="${t.type === 'income' ? 'pos' : 'neg'}">${t.amount.toLocaleString()} ‚Ç∏</b><br>
            <small class="muted">${timeStr} | ${t.subcategory || t.categoryName}${acc}</small>
            ${t.comment ? `<div style="color:#65d48b;font-size:12px;">üìù ${t.comment}</div>` : ''}
          </div>
          <button onclick="deleteTx('${t.id}')" style="background:none;border:none;color:#444;padding:10px;cursor:pointer;">‚úï</button>
        </div>`;
      }).join("") || '<div class="muted" style="padding:10px;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';
    }

    window.render = render;

    window.deleteTx = async (id) => {
      if (confirm("–£–¥–∞–ª–∏—Ç—å?")) {
        await window.fbMethods.deleteDoc(window.fbMethods.doc(window.fbDB, "transactions", id));
      }
    };
  </script>
</body>
</html>
